<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ²ˆé»˜ä¹‹å³¶ v24.0ï¼šæ‰‹æ©Ÿé©é…ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --board-bg: #d3d3cb;
            --text-color: #111;
            --accent-red: #8a1c1c;
            --accent-gold: #c5a059;
            --accent-green: #3d6647;
            --color-opportunity: #e6c95e;
            --color-destiny: #b39ddb;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Courier New", "PMingLiU", serif;
            background-color: var(--bg-color);
            color: #bbb;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            min-height: 100vh; /* æ”¹ç‚º min-height å…è¨±æ²å‹• */
            overflow-x: hidden;
        }

        /* --- å½ˆçª—ç³»çµ± (å…¨é¢ RWD åŒ–) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px;
        }

        /* é€šç”¨å½ˆçª—æ¨£å¼ */
        .intro-box, .ending-box, .death-box, .betrayal-box, .encounter-box, .history-box, .choice-box {
            width: 100%;
            max-width: 600px; /* é›»è…¦ç‰ˆæœ€å¤§å¯¬åº¦ */
            padding: 30px;
            text-align: center;
            animation: fadeIn 0.5s;
            max-height: 90vh;
            overflow-y: auto; /* å…§å®¹å¤ªå¤šå¯æ²å‹• */
        }

        .intro-box { background: #1a1a1a; border: 4px double #d63031; box-shadow: 0 0 80px rgba(200, 0, 0, 0.3); }
        .ending-box { background: #151515; border: 2px solid var(--accent-gold); box-shadow: 0 0 100px rgba(197, 160, 89, 0.2); }
        .death-box { background: #0a0a0a; border: 1px solid #500; box-shadow: 0 0 100px rgba(138, 28, 28, 0.4); }
        .betrayal-box { background: #000; border: 4px solid #8a1c1c; box-shadow: inset 0 0 50px #500; }
        .encounter-box { background: #1a2530; border: 2px solid #aaa; }
        .history-box { background: #222; border: 1px solid #888; box-shadow: 0 0 80px rgba(255, 255, 255, 0.15); }
        .choice-box { background: #252525; border: 1px solid #aaa; box-shadow: 0 0 50px rgba(0,0,0,1); }

        /* å½ˆçª—æ–‡å­—èª¿æ•´ */
        .intro-title, .ending-title, .death-title, .history-title, .betrayal-title {
            font-size: 32px; font-weight: 900; margin-bottom: 15px; 
            border-bottom: 1px solid #444; padding-bottom: 15px;
        }
        .intro-title { color: #d63031; }
        .ending-title { color: var(--accent-gold); }
        .death-title { color: #cc0000; }
        .history-title { color: var(--accent-gold); }
        .betrayal-title { color: #ff0000; }

        .intro-text, .history-desc, .betrayal-desc { 
            font-size: 16px; line-height: 1.6; color: #ddd; margin-bottom: 20px; 
        }
        
        .history-year { font-size: 50px; font-weight: bold; color: rgba(255,255,255,0.08); margin-bottom: -20px; font-family: Impact; }
        .history-effect { background: #3a2a2a; color: #ffaaaa; padding: 10px; border: 1px solid #555; font-size: 14px; margin-bottom: 20px;}
        .encounter-avatars { font-size: 40px; margin: 15px 0; display: flex; justify-content: center; gap: 20px; }
        .ending-highlight { color: #ff6b6b; font-weight: bold; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .choice-btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        .choice-btn {
            flex: 1; min-width: 120px; padding: 12px; border: none; font-size: 15px; cursor: pointer; font-weight: bold;
            transition: 0.2s; border-radius: 4px; display: flex; flex-direction: column; gap: 5px;
        }
        .btn-risk { background: #6e2c2c; color: #fff; border: 1px solid #8f4d4d; }
        .btn-safe { background: #3b556e; color: #fff; border: 1px solid #5b758e; }
        .btn-betray { background: #000; color: #ff4444; border: 1px solid #ff4444; }
        .btn-connect { background: #3d6647; color: #fff; border: 1px solid #5d8667; }

        /* Role Select (RWD) */
        .role-select-container { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center;}
        .role-card-btn {
            background: #1f1f1f; border: 1px solid #444; color: #fff;
            padding: 15px; width: 45%; max-width: 160px; /* æ‰‹æ©Ÿä¸Šä¸¦æ’ */
            cursor: pointer; text-align: center; border-radius: 4px; position: relative;
        }
        .role-card-btn:active { transform: scale(0.95); }
        .role-icon { font-size: 36px; margin-bottom: 5px; }
        .role-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .role-desc { font-size: 10px; color: #888; line-height: 1.3; text-align: left; border-top: 1px dashed #444; padding-top: 5px; margin-top: 5px;}

        /* Game Layout (Flex Column for Mobile) */
        .header-info { display: flex; flex-direction: column; gap: 5px; align-items: center; margin-bottom: 10px; width: 100%; justify-content: center; }
        .timeline-container { width: 100%; max-width: 500px; height: 8px; background: #222; border-radius: 5px; position: relative; overflow: hidden; border: 1px solid #444; margin-top: 5px;}
        .timeline-fill { height: 100%; background: linear-gradient(90deg, #333, #666, var(--accent-gold)); width: 0%; transition: width 1s linear; }
        .timeline-text { position: absolute; width: 100%; text-align: center; top: -2px; line-height: 10px; font-size: 9px; color: #fff; letter-spacing: 2px;}

        .game-container { 
            display: flex; 
            gap: 15px; 
            width: 100%; 
            max-width: 1100px; 
            /* é›»è…¦ç‰ˆé è¨­æ©«å‘ï¼Œä¸‹é¢ Media Query æœƒæ”¹ */
            flex-direction: row; 
            align-items: flex-start;
        }

        /* æ£‹ç›¤ (Responsive) */
        .board {
            background-color: var(--board-bg); color: var(--text-color);
            display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(6, 1fr);
            /* é—œéµï¼šå¯¬åº¦è‡ªé©æ‡‰ï¼Œæœ€å¤§ 600px */
            width: 100%; 
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
            max-width: 600px; 
            max-height: 600px;
            border: 6px solid #111; position: relative;
            box-shadow: 0 0 15px #000;
            flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“ */
        }
        .center-area { grid-column: 2 / 6; grid-row: 2 / 6; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 10px; position: relative;}
        
        .quote-container { margin-top: 10px; width: 95%; animation: fadeIn 1s; }
        .quote-text { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px; font-family: "Kaiti TC", "STKaiti", serif; text-shadow: 1px 1px 0px rgba(255,255,255,0.5);}
        .quote-author { font-size: 11px; color: #555; font-style: italic; width: 100%; text-align: right;}
        .year-badge { font-size: 12vw; font-weight: 900; color: rgba(0,0,0,0.1); font-family: "Arial Black", sans-serif; line-height: 1;}
        /* é™åˆ¶å¹´ä»½æœ€å¤§å­—é«” */
        @media (min-width: 600px) { .year-badge { font-size: 60px; } }

        .tile { 
            border: 1px solid #777; display: flex; flex-direction: column; justify-content: space-between; 
            padding: 2px; font-size: 10px; font-weight: bold; position: relative; 
            background: rgba(255,255,255,0.45); transition: all 0.2s;
            overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
        }
        .tile.danger { background-color: #dcb5b5; border-top: 3px solid var(--accent-red); }
        .tile.safe { background-color: #c5dbbf; border-top: 3px solid var(--accent-green); }
        .tile.home { background-color: #cce5ff; border-top: 3px solid #007bff; }
        .tile.jail { background-color: #666; color: white; border-top: 3px solid #000; }
        .tile.exit { background-color: #fff; border: 3px double var(--accent-gold); }
        .tile.opportunity { background-color: #f9e79f; border-top: 3px solid var(--color-opportunity); }
        .tile.destiny { background-color: #d7bde2; border-top: 3px solid var(--color-destiny); }
        
        .tile-label { text-align: center; font-size: 8px; color: #fff; padding: 1px 2px; border-radius: 2px; margin-bottom: 1px; align-self: center; font-weight: normal;}
        .label-opp { background: #cba308; color: #000; }
        .label-dest { background: #794a99; }
        .label-home { background: #004a99; }
        .tile-name { text-align: center; font-size: 2.5vw; } /* æ‰‹æ©Ÿå­—é«” */
        @media (min-width: 600px) { .tile-name { font-size: 12px; } }

        .players-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1px; }
        .token { width: 2.5vw; height: 2.5vw; max-width: 14px; max-height: 14px; border-radius: 50%; border: 1px solid #fff; box-shadow: 1px 1px 3px rgba(0,0,0,0.8); font-size: 9px; display: flex; align-items: center; justify-content: center; position: relative; }
        .token.has-visa::after { content: "ğŸ«"; position: absolute; top: -5px; right: -5px; font-size: 10px; }

        /* æ§åˆ¶å€ (Responsive) */
        .controls { 
            flex: 1; background: #1a1a1a; padding: 15px; 
            display: flex; flex-direction: column; gap: 10px; 
            border-radius: 2px; border: 1px solid #333;
            width: 100%; /* æ‰‹æ©Ÿä½”æ»¿ */
        }
        .player-card { background: #282828; padding: 8px; border-left: 3px solid #444; display: grid; grid-template-columns: 25px 1fr auto; align-items: center; gap: 8px; font-size: 13px; transition: all 0.3s;}
        .player-card.active { background-color: #3a3a3a; border-left-color: #fff; transform: translateX(5px); box-shadow: -2px 2px 5px rgba(0,0,0,0.5);}
        .player-card.eliminated { opacity: 0.4; text-decoration: line-through; filter: grayscale(100%);}
        .player-card.escaped { border-left-color: var(--accent-gold); background: #3d3520; }
        .player-card.survived { border-left-color: var(--accent-green); background: #203d25; }
        .is-ai { font-size: 10px; color: #888; border: 1px solid #555; padding: 0 4px; border-radius: 2px; margin-left: 5px;}
        .is-sinner { border: 1px solid #f00; color: #f00; font-size:10px; padding:0 2px; margin-left:5px;}

        .btn { background: var(--accent-red); color: white; border: none; padding: 15px; font-size: 16px; cursor: pointer; font-weight: bold; border-radius: 4px; box-shadow: 0 4px 0 #500;}
        .btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #500;}
        .btn:disabled { background: #444; cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none;}

        .log-box { 
            background: #000; color: #aaa; font-family: monospace; 
            flex: 1; 
            min-height: 150px; max-height: 250px; /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto; padding: 10px; font-size: 12px; border: 1px solid #444; 
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #222; padding-bottom: 4px; line-height: 1.4; }
        .log-bad { color: #ff6b6b; }
        .log-good { color: #6bff84; }
        .log-item { color: #ffd700; }
        .log-home-bad { color: #ff4444; background: rgba(255, 0, 0, 0.15); padding: 2px; border-left: 2px solid #f00; }
        .log-ai-action { color: #b3e5fc; } 
        .log-ai-bad { color: #ef9a9a; } 
        .log-ai-good { color: #a5d6a7; } 
        .log-event { color: #fff; background: #333; border-left: 4px solid var(--accent-gold); padding: 8px; font-weight: bold;}
        .log-win { background: #222; color: #fff; padding: 3px; text-align: center; border: 1px solid #fff;}
        .log-betray { border-left: 4px solid #f00; padding-left: 5px; color: #f88; font-style: italic; }
        .log-skill { color: #c5a059; font-weight: bold; border: 1px solid #c5a059; padding: 2px; display: inline-block;}

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }

        #dice-display { font-size: 40px; color: var(--accent-red); margin: 5px 0; }
        .skill-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* --- Media Queries for Mobile --- */
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column; /* ä¸Šä¸‹æ’åˆ— */
                align-items: center;
            }
            .board {
                margin-bottom: 10px;
            }
            .controls {
                width: 100%;
            }
            .intro-title, .ending-title, .death-title { font-size: 24px; }
            .intro-text { font-size: 14px; }
            .role-card-btn { padding: 10px; }
            .role-icon { font-size: 28px; }
        }
    </style>
</head>
<body>

    <div class="modal-overlay" id="role-select-screen">
        <h1 style="font-size: 32px; margin-bottom: 10px;">æ²ˆé»˜ä¹‹å³¶</h1>
        <p style="color:#aaa; font-size:14px;">è«‹é¸æ“‡æ‚¨çš„èº«ä»½</p>
        <div class="role-select-container">
            <div class="role-card-btn" onclick="selectRole('student')">
                <div class="role-icon">ğŸ“</div>
                <div class="role-name" style="color:#4facfe">å­¸ç”Ÿ</div>
                <div class="role-desc">
                    <strong>[æŠ€èƒ½: ç–¾è¡Œ]</strong><br>
                    æ“²å…©é¡†éª°å­é¸ä¸€ã€‚
                </div>
            </div>
            <div class="role-card-btn" onclick="selectRole('teacher')">
                <div class="role-icon">ğŸ‘“</div>
                <div class="role-name" style="color:#fbc2eb">æ•™å¸«</div>
                <div class="role-desc">
                    <strong>[æŠ€èƒ½: æ˜å“²]</strong><br>
                    æŠµæ“‹ä¸€æ¬¡å±éšªå‚·å®³ã€‚
                </div>
            </div>
            <div class="role-card-btn" onclick="selectRole('worker')">
                <div class="role-icon">ğŸ”¨</div>
                <div class="role-name" style="color:#ff9a9e">å·¥äºº</div>
                <div class="role-desc">
                    <strong>[æŠ€èƒ½: ç¡¬æ°£]</strong><br>
                    å›å¾©15HP (åœä¸€å›)ã€‚
                </div>
            </div>
            <div class="role-card-btn" onclick="selectRole('doctor')">
                <div class="role-icon">âš•ï¸</div>
                <div class="role-name" style="color:#00f260">é†«å¸«</div>
                <div class="role-desc">
                    <strong>[æŠ€èƒ½: è¨ºç™‚]</strong><br>
                    -5HP æ› +25HPã€‚
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="intro-screen" style="display:none;">
        <div class="intro-box">
            <div class="intro-title">âš ï¸ æˆ’åš´ä»¤é ’å¸ƒ</div>
            <div class="intro-text">
                <p>1949å¹´5æœˆ19æ—¥</p>
                <p>å°ç£çœè­¦å‚™ç¸½å¸ä»¤éƒ¨å®£å‘Šï¼š<br>è‡ªæ˜æ—¥é›¶æ™‚èµ·ï¼Œå…¨å¢ƒå¯¦æ–½æˆ’åš´ã€‚</p>
                <hr style="border-color:#555; margin:20px 0; opacity:0.5;">
                <p style="color:#ccc; font-size:14px;">é€™ä¸æ˜¯éŠæˆ²ï¼Œé€™æ˜¯æ­·å²çš„é‡æ¼”ã€‚<br>åœ¨ææ‡¼çš„é™°å½±ä¸‹ï¼Œæ´»è‘—ï¼Œå°±æ˜¯æœ€å¤§çš„åæŠ—ã€‚</p>
            </div>
            <button class="btn" style="width:100%;" onclick="startGame()">é€²å…¥æ²ˆé»˜çš„å¹´ä»£</button>
        </div>
    </div>

    <div class="modal-overlay" id="death-modal" style="display:none;">
        <div class="death-box">
            <div class="death-title">ğŸ¥€ æ®è½</div>
            <div class="intro-text" style="text-align: justify;">
                <p>æ§è²åŠƒç ´äº†å¯‚éœçš„æ¸…æ™¨ï¼Œæˆ–è€…ï¼Œæ˜¯åœ¨æŸå€‹ç„¡äººçŸ¥æ›‰çš„æ·±å¤œè£¡åœæ­¢äº†å‘¼å¸ã€‚</p>
                <p>ä½ çš„å®¶äººé‚„åœ¨ç­‰è‘—ä½ å›å®¶åƒæ™šé£¯ï¼Œä½†é‚£å¼µæ¤…å­å°‡æ°¸é ç©ºè‘—ã€‚</p>
                <hr style="border-color:#444; margin:20px 0;">
                <p style="color:#888; font-size:14px;">
                    ä½ æˆç‚ºäº†æ™‚ä»£æ´ªæµä¸‹ï¼Œä¸€å€‹æ²’æœ‰åå­—çš„æ•¸å­—ã€‚<br>
                    åœ¨æª”æ¡ˆåº«çš„å¡µåŸƒä¸­ï¼Œæ²ˆé»˜åœ°è¨´èªªè‘—æœªç«Ÿçš„é»æ˜ã€‚
                </p>
            </div>
            <button class="btn" style="width:100%; background:#333; border:1px solid #555;" onclick="location.reload()">é‡æ–°ä¾†é</button>
        </div>
    </div>

    <div class="modal-overlay" id="encounter-modal" style="display:none;">
        <div class="encounter-box">
            <div class="history-title">ğŸ‘¥ ç‹¹è·¯ç›¸é€¢</div>
            <div id="encounter-text" style="color:#ddd; margin-bottom:10px; font-size:14px;"></div>
            <div class="encounter-avatars" id="encounter-avatars"></div>
            <p style="color:#888; font-size:12px; margin-bottom:20px;">åœ¨é€™æ•æ„Ÿæ™‚åˆ»ï¼Œä¿¡ä»»æ˜¯æœ€å¤§çš„è³­æ³¨ã€‚</p>
            <div class="choice-btn-group">
                <button class="choice-btn btn-connect" onclick="game.resolveEncounter(true)">
                    ğŸ’¬ ä½è²è©¦æ¢<br><span style="font-size:10px; opacity:0.8;">é¢¨éšªé«˜ | è‹¥æ˜¯åŒå¿—+10 HP</span>
                </button>
                <button class="choice-btn btn-safe" onclick="game.resolveEncounter(false)">
                    ğŸš« åŒ†åŒ†è¿´é¿<br><span style="font-size:10px; opacity:0.8;">å®‰å…¨ | å¾®é‡å®‰å¿ƒ (+5 HP)</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="history-modal" style="display:none;">
        <div class="history-box">
            <div class="history-year" id="hist-year"></div>
            <div class="history-title" id="hist-title"></div>
            <hr style="border-color:#555; margin:15px 0; opacity:0.5;">
            <div class="history-desc" id="hist-desc"></div>
            <div class="history-effect" id="hist-effect"></div>
            <button class="btn" style="width:100%;" onclick="game.closeHistoryModal()">ç¹¼çºŒæ­·å²</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="choice-modal" style="display:none;">
        <div class="choice-box">
            <div style="font-size:24px; color:var(--accent-gold); margin-bottom:15px; font-weight:bold;" id="choice-title"></div>
            <div style="font-size:14px; color:#ddd; margin-bottom:30px; line-height:1.6; text-align:left;" id="choice-desc"></div>
            <div class="choice-btn-group">
                <button class="choice-btn btn-risk" id="btn-risk" onclick="game.resolveChoice(true)">
                    <span id="risk-text"></span><span style="font-size:10px; opacity:0.8;" id="risk-sub"></span>
                </button>
                <button class="choice-btn btn-safe" id="btn-safe" onclick="game.resolveChoice(false)">
                    <span id="safe-text"></span><span style="font-size:10px; opacity:0.8;" id="safe-sub"></span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="betrayal-modal" style="display:none;">
        <div class="betrayal-box">
            <div class="betrayal-title">ğŸ’€ ç€•æ­»æŠ‰æ“‡</div>
            <div class="betrayal-desc">ä½ è¢«é€¼åˆ°äº†æ¥µé™ï¼Œèª¿æŸ¥å®˜éçµ¦ä½ ä¸€å¼µç´™ï¼šã€Œå¯«ä¸‹å¹¾å€‹åå­—ï¼Œä½ å°±èƒ½æ´»è‘—èµ°å‡ºå»ã€‚ã€</div>
            <div class="choice-btn-group">
                <button class="choice-btn btn-betray" onclick="game.resolveBetrayal(true)">å‡ºè³£è‰¯å¿ƒ<br><span style="font-size:10px;">å¿…æ´» (HP+40) | ç½ªäºº</span></button>
                <button class="choice-btn btn-safe" onclick="game.resolveBetrayal(false)">å¯§æ­»ä¸å±ˆ<br><span style="font-size:10px;">70% æ­» | 30% æ´»</span></button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="escape-modal" style="display:none;">
        <div class="ending-box" style="border-color:#4facfe;">
            <div class="ending-title" style="color:#4facfe; border-color:#4facfe;">âœˆï¸ æˆåŠŸæµäº¡</div>
            <div class="intro-text" style="text-align: justify;">
                <p>ä½ çœ‹è‘—çª—å¤–é€æ¼¸ç¸®å°çš„å³¶å¶¼ï¼Œä½ çŸ¥é“è‡ªå·±å®‰å…¨äº†ï¼Œä½†ä¹ŸçŸ¥é“é€™ä¸€æ¬¡é›¢é–‹ï¼Œå¯èƒ½å°±æ˜¯å¹¾åå¹´çš„å…‰é™°ã€‚</p>
                <hr style="border-color:#444; margin:20px 0;">
                <p style="color:#bbb; font-size:14px;">åªèƒ½åœ¨å¤¢ä¸­ï¼Œå›åˆ°é‚£å€‹æ²ˆé»˜ä¹‹å³¶ã€‚</p>
            </div>
            <button class="btn" style="background:#4facfe; color:#000; width:100%;" onclick="game.closeEscapeModal()">ç¹¼çºŒæ—è§€æ­·å²</button>
        </div>
    </div>

    <div class="modal-overlay" id="ending-screen" style="display:none;">
        <div class="ending-box">
            <div class="ending-title">1987 æˆ’åš´è§£é™¤</div>
            <div class="intro-text" style="text-align: justify;" id="ending-content"></div>
            <button class="btn" style="width:100%; margin-top:20px; background:var(--accent-gold); color:#000;" onclick="location.reload()">éŠ˜è¨˜æ­·å² (é‡æ–°é–‹å§‹)</button>
        </div>
    </div>

    <div class="header-info">
        <h1 style="font-size:18px;">æ²ˆé»˜ä¹‹å³¶ v24.0</h1>
        <div class="timeline-container">
            <div class="timeline-fill" id="timeline-bar"></div>
            <div class="timeline-text" id="timeline-text">1949 / 1987</div>
        </div>
    </div>

    <div class="game-container">
        <div class="board" id="board">
            <div class="center-area">
                <div id="year-display" class="year-badge">1949</div>
                <div id="dice-display">ğŸ²</div>
                <div class="quote-container" id="quote-container">
                    <div class="quote-text" id="quote-text"></div>
                    <div class="quote-author" id="quote-author"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div id="player-status"></div>
            
            <div class="skill-area">
                <button id="roll-btn" class="btn" onclick="game.humanPlay()">ğŸ² æ“²éª°å­</button>
                <button id="skill-btn" class="btn btn-skill" onclick="game.useSkill()" disabled>
                    <span id="skill-name">æŠ€èƒ½</span>
                    <div style="font-size:10px; font-weight:normal;" id="skill-desc">å†·å»ä¸­</div>
                </button>
            </div>

            <div class="log-box" id="game-log">
                <div class="log-entry" style="color:#fff">è«‹é¸æ“‡èº«ä»½é–‹å§‹éŠæˆ²...</div>
            </div>
        </div>
    </div>

    <script>
        // --- Data ---
        const dilemmas = [
            { title: "æ·±å¤œæ•²é–€", desc: "åŠå¤œæ€¥ä¿ƒæ•²é–€ï¼Œæ»¿èº«æ˜¯è¡€çš„å­¸ç”Ÿæ±‚ä½ è®“ä»–èº²ä¸€æ™šã€‚", type: "destiny", optA: { text: "é–‹é–€è—åŒ¿", risk: 0.5, success: { msg: "ä½ æ•‘äº†ä»–ï¼Œç²è´ˆè¯çµ¡æ–¹å¼ã€‚", effect: 15, visa: false, narrative: "ä½ å†’éšªé–‹é–€å°‡äººæ‹‰é€²å±‹å…§ï¼Œé©šéšªåœ°é¿é–‹äº†å·¡é‚éšŠçš„è€³ç›®ã€‚" }, fail: { msg: "æ˜¯é™·é˜±ï¼ç‰¹å‹™è¡å…¥ã€‚", effect: -25, visa: false, narrative: "å‰›æ‰“é–‹é–€é–ï¼Œé–€å°±è¢«è¸¹é–‹ï¼é€™æ˜¯é‡å°ä½ çš„èª˜æ•è¡Œå‹•ã€‚" } }, optB: { text: "ç†„ç‡ˆè£ç¡", risk: 0.0, success: { msg: "è…³æ­¥è²é å»ï¼Œéš”å¤©æ²³é‚Šç™¼ç¾å±é«”ã€‚", effect: -5, visa: false, narrative: "ä½ é¸æ“‡ç†„ç‡ˆå±ä½å‘¼å¸ï¼Œç›´åˆ°è…³æ­¥è²é å»ã€‚ä½†è‰¯å¿ƒçš„è­´è²¬è®“ä½ å¾¹å¤œé›£çœ ã€‚" }, fail: { msg: "", effect: 0, narrative: "" } } },
            { title: "éºå¿˜åŒ…è£¹", desc: "è»Šç«™é•·æ¤…ä¸Šæœ‰å€‹æ²’äººèªé ˜çš„åŒ…è£¹ã€‚", type: "opportunity", optA: { text: "æ‰“é–‹æª¢æŸ¥", risk: 0.4, success: { msg: "è—è‘—å‰å¾€é¦™æ¸¯çš„èˆ¹ç¥¨ï¼", effect: 0, visa: true, narrative: "ä½ å¿ƒé©šè†½è·³åœ°è§£é–‹åŒ…è£¹ï¼Œç™¼ç¾è£¡é¢ç«Ÿå¤¾è‘—ä¸€å¼µçè²´çš„å‡ºå¢ƒè­‰ä»¶ï¼" }, fail: { msg: "è£¡é¢æ˜¯ç¦æ›¸ï¼è­¦å¯Ÿå‰›å¥½ç¶“éã€‚", effect: -15, visa: false, narrative: "åŒ…è£¹è£¡å…¨æ˜¯ç¦æ›¸ï¼ä½ é‚„ä¾†ä¸åŠåæ‡‰ï¼Œè‚©è†€å°±è¢«ä¸€éš»ç²—ç³™çš„å¤§æ‰‹æŒ‰ä½..." } }, optB: { text: "å¿«æ­¥é›¢é–‹", risk: 0.0, success: { msg: "æ˜å“²ä¿èº«ï¼Œæ··å…¥äººç¾¤ã€‚", effect: 0, visa: false, narrative: "ä½ å£“ä½å¸½æ²¿ï¼Œå‡è£æ²’çœ‹è¦‹é‚£å€‹åŒ…è£¹ï¼Œå¿«æ­¥æ··å…¥äººç¾¤ä¸­é›¢é–‹äº†ç¾å ´ã€‚" }, fail: { msg: "", effect: 0, narrative: "" } } },
            { title: "å½é€ è­‰ä»¶", desc: "å°åˆ·å» å¸«å‚…å•ä½ è¦ä¸è¦è²·å‡è­‰ä»¶ï¼Ÿ", type: "opportunity", optA: { text: "å†’éšªè³¼è²·", risk: 0.5, success: { msg: "èŠ±å…‰ç©è“„ï¼Œæ‹¿åˆ°è­‰ä»¶ï¼", effect: -10, visa: true, narrative: "ä½ é¡«æŠ–è‘—äº¤å‡ºæ‰€æœ‰ç©è“„ï¼Œæ›ä¾†äº†ä¸€å¼µé€šå¾€è‡ªç”±çš„ç´™ç‰‡ã€‚" }, fail: { msg: "å¸«å‚…æ˜¯ç·šäººï¼ç•¶å ´è¢«æ•ã€‚", effect: -20, visa: false, narrative: "æ‰å‰›æ‹¿å‡ºéŒ¢ï¼ŒåŸ‹ä¼åœ¨å¾Œçš„æ†²å…µå°±è¡äº†å‡ºä¾†ã€‚é€™æ˜¯ä¸€å€‹å±€ã€‚" } }, optB: { text: "å©‰æ‹’äº¤æ˜“", risk: 0.0, success: { msg: "ä¸æ•¢å†’éšªï¼Œæ–é ­æ‹’çµ•ã€‚", effect: 5, visa: false, narrative: "ä½ æ–æ–é ­æ‹’çµ•äº†ã€‚é›–ç„¶éºæ†¾ï¼Œä½†çœ‹è‘—å¸«å‚…é™°æ²ˆçš„çœ¼ç¥ï¼Œä½ çŸ¥é“è‡ªå·±åšå°äº†ã€‚" }, fail: { msg: "", effect: 0, narrative: "" } } },
            { title: "å¯†ä¿¡è¨—ä»˜", desc: "é€ƒäº¡è€å‹è¨—ä½ ä¿ç®¡å®¶æ›¸ã€‚", type: "destiny", optA: { text: "æ”¶ä¸‹å¯†ä¿¡", risk: 0.6, success: { msg: "æˆåŠŸè½‰äº¤ï¼Œå®¶å±¬æ„Ÿæ¿€æ¶•é›¶ã€‚", effect: 20, visa: false, narrative: "ä½ å†’æ­»å°‡ä¿¡é€é”ã€‚çœ‹åˆ°å°æ–¹å®¶äººè®€ä¿¡æ™‚çš„æ·šæ°´ï¼Œä½ è¦ºå¾—ä¸€åˆ‡éƒ½å€¼å¾—äº†ã€‚" }, fail: { msg: "ä¿¡ä»¶è¢«æœå‡ºï¼åš´åˆ‘æ‹·æ‰“ã€‚", effect: -30, visa: false, narrative: "æ·±å¤œæŸ¥æˆ¶å£æ™‚ï¼Œè—åœ¨å¤¾å±¤çš„ä¿¡ä»¶è¢«æœå‡ºï¼ä½ è¢«å¸¶å¾€èª¿æŸ¥å±€åœ°ä¸‹å®¤..." } }, optB: { text: "æ‹’çµ•è¨—ä»˜", risk: 0.1, success: { msg: "å¹¾å¤©å¾Œå‚³ä¾†ä»–æ­»è¨Šã€‚", effect: -5, visa: false, narrative: "ä½ æ‹’çµ•äº†è€å‹ã€‚å¹¾å¤©å¾Œå ±ç´™ä¸ŠåˆŠç™»äº†ä»–çš„æ­»è¨Šï¼Œé‚£å°ä¿¡æ°¸é é€ä¸å‡ºå»äº†ã€‚" }, fail: { msg: "æœ‹å‹ä¾›å‡ºäº†ä½ ï¼Œä»è¢«ç´„è«‡ã€‚", effect: -10, visa: false, narrative: "æœ‹å‹å—ä¸äº†é…·åˆ‘ä¾›å‡ºäº†ä½ æ›¾è¦‹éä»–ï¼Œä½ é‚„æ˜¯è¢«å«å»å–èŒ¶è­¦å‘Šäº†ä¸€ç•ªã€‚" } } }
        ];

        const historicalEvents = [
            { year: 1949, title: "æ¾æ¹–ä¸ƒä¸€ä¸‰äº‹ä»¶", desc: "æµäº¡å­¸ç”Ÿè¢«å¼·è¿«ç·¨å…¥è»éšŠï¼Œæ ¡é•·èˆ‡å­¸ç”Ÿé­æ§‹é™·æ§æ±ºã€‚", trigger: false, apply: (p) => { if(['student','teacher'].includes(p.roleId)){ p.hp-=15; return "å¸«ç”Ÿå—é›£ï¼Œæ ¡åœ’äº¦éæ·¨åœŸ (-15 HP)"; } else { p.hp-=5; return "ç›®æ“Šææ€– (-5 HP)"; } } },
            { year: 1952, title: "é¹¿çªŸåŸºåœ°æ¡ˆ", desc: "è»è­¦åŒ…åœé¹¿çªŸæ‘ï¼Œå¤§é‡æ‘æ°‘èˆ‡ç¤¦å·¥è¢«æ•ã€‚", trigger: false, apply: (p) => { if(p.roleId==='worker'){ p.hp-=20; return "èº«è™•é¢¨æš´ä¸­å¿ƒï¼Œæ­»å‚·æ…˜é‡ (-20 HP)"; } else { p.hp-=5; return "å±±å€è‚…æ®º (-5 HP)"; } } },
            { year: 1954, title: "ç¶ å³¶å†å›äº‚æ¡ˆ", desc: "ç„ä¸­æ”¿æ²»çŠ¯å› å‚³éç´™æ¢è¢«è™•æ±ºã€‚", trigger: false, apply: (p) => { if(p.skip>0){ p.hp-=20; return "ç„ä¸­æ•´è‚…ï¼Œåœ¨åŠ«é›£é€ƒ (-20 HP)"; } else { p.hp-=10; return "é€£ç›£ç„éƒ½ä¸å®‰å…¨ (-10 HP)"; } } },
            { year: 1960, title: "é›·éœ‡æ¡ˆçˆ†ç™¼", desc: "ã€Šè‡ªç”±ä¸­åœ‹ã€‹åœåˆŠï¼Œé›·éœ‡è¢«æ•ã€‚è¨€è«–è‡ªç”±å¯’å†¬ã€‚", trigger: false, apply: (p) => { p.hp -= 10; return "è¨€è«–ç·Šç¸®ï¼Œæ„Ÿåˆ°å£“æŠ‘ (-10 HP)"; } },
            { year: 1970, title: "æ³°æºäº‹ä»¶", desc: "æ±Ÿç‚³èˆˆç­‰äººç™¼å‹•ç›£ç„èµ·ç¾©å¤±æ•—ï¼Œäº”äººé­æ§æ±ºã€‚", trigger: false, apply: (p) => { p.hp -= 10; return "æ­¦è£èµ·ç¾©å°è‡´å…¨é¢æˆ’å‚™ (-10 HP)"; } },
            { year: 1977, title: "ä¸­å£¢äº‹ä»¶", desc: "é¸èˆ‰èˆå¼Šå¼•ç™¼ç¾¤çœ¾åŒ…åœè­¦å±€ã€‚", trigger: false, apply: (p) => { p.hp -= 5; return "è¡—é ­æ··äº‚ï¼Œå—åˆ°æ³¢åŠ (-5 HP)"; } },
            { year: 1979, title: "ç¾éº—å³¶äº‹ä»¶", desc: "ä¸–ç•Œäººæ¬Šæ—¥é®å£“ï¼Œå…¨å³¶å¤§æœæ•ã€‚", trigger: false, apply: (p) => { const dangerZones = [2, 5, 7, 9, 11, 14, 18]; if (dangerZones.includes(p.pos)) { p.skip = 3; return "èº«è™•å±éšªå€åŸŸï¼Œç›´æ¥è¢«æ•å…¥ç„ï¼(åœ3å›åˆ)"; } p.hp -= 20; return "é¢¨è²é¶´å”³ï¼Œèº«å¿ƒä¿±ç–² (-20 HP)"; } },
            { year: 1980, title: "æ—å®…è¡€æ¡ˆ", desc: "ç¾éº—å³¶å¤§å¯©æœŸé–“ï¼Œæ—ç¾©é›„å®¶å±¬æ…˜é­æ®ºå®³ã€‚", trigger: false, apply: (p) => { p.hp -= 20; return "ç¤¾æœƒç± ç½©åœ¨æœªçŸ¥çš„ææ€–ä¸­ï¼Œäººå¿ƒæƒ¶æƒ¶ (-20 HP)"; } },
            { year: 1981, title: "é™³æ–‡æˆå‘½æ¡ˆ", desc: "æ—…ç¾å­¸è€…è¿”å°è¢«è­¦ç¸½ç´„è«‡å¾Œï¼Œé™³å±å°å¤§æ ¡åœ’ã€‚", trigger: false, apply: (p) => { const isIntellectual = ['student', 'teacher', 'doctor'].includes(p.roleId); if(isIntellectual) { p.hp -= 15; return "çŸ¥è­˜ä»½å­é­åˆ°åš´é‡é–å®šèˆ‡ç›£æ§ (-15 HP)"; } else { p.hp -= 5; return "æ ¡åœ’èˆ‡ç¤¾æœƒæ°£æ°›è‚…æ®º (-5 HP)"; } } },
            { year: 1984, title: "æ±Ÿå—æ¡ˆ", desc: "ä½œå®¶åŠ‰å®œè‰¯åœ¨ç¾é­æƒ…å ±å±€å¸æ”¶çš„é»‘é“ä»½å­åˆºæ®ºã€‚", trigger: false, apply: (p) => { return "æƒ…å ±å–®ä½å¤±æ§ï¼Œåš´é‡æ‰“æ“Šè”£å®¶æ”¿æ¬Šå¨ä¿¡ (ç„¡å‚·)"; } },
            { year: 1986, title: "519 ç¶ è‰²è¡Œå‹•", desc: "é„­å—æ¦•ç­‰äººç™¼èµ·æŠ—è­°æˆ’åš´37é€±å¹´è¡Œå‹•ã€‚", trigger: false, apply: (p) => { p.hp = Math.min(100, p.hp + 15); return "äººæ°‘é–‹å§‹é›†çµï¼Œçœ‹è¦‹å¾®å…‰ (+15 HP)"; } },
            { year: 1986, title: "åœ“å±±çµ„é»¨", desc: "æ°‘ä¸»é€²æ­¥é»¨æˆç«‹ï¼Œå¨æ¬Šé«”åˆ¶é¬†å‹•ã€‚", trigger: false, apply: (p) => { p.hp = Math.min(100, p.hp + 25); return "æ°‘ä¸»æ›™å…‰ï¼Œæ„å¿—åŠ›å¤§å¹…å›å¾© (+25 HP)"; } }
        ];

        const quoteLibrary = [
            { min: 1949, max: 1959, text: "ã€Œå¯§å¯éŒ¯æ®ºä¸€ç™¾ï¼Œä¸å¯éŒ¯æ”¾ä¸€äººã€‚ã€", author: "â€” æ•´è‚…æŒ‡ä»¤" },
            { min: 1949, max: 1987, text: "ã€Œç‰†å£æœ‰è€³ï¼Œèªªè©±å°å¿ƒã€‚ã€", author: "â€” æ°‘é–“è­¦èª" },
            { min: 1949, max: 1969, text: "ã€Œå£“ä¸æ‰çš„ç«ç‘°ï¼Œåœ¨æ°´æ³¥åœ°è£¡é–‹èŠ±ã€‚ã€", author: "â€” æ¥Šé€µ" },
            { min: 1960, max: 1975, text: "ã€Œæˆ‘å€‘åœ¨ç…‰ç„ä¸­ï¼Œåªèƒ½ç”¨éˆé­‚å°è©±ã€‚ã€", author: "â€” æŸæ¥Š" },
            { min: 1979, max: 1987, text: "ã€Œäººæ°‘æœ‰æ¬Šåˆ©èªªå‡ºå¿ƒè£¡çš„è©±ã€‚ã€", author: "â€” è¡—é ­æ¨™èª" },
            { min: 1980, max: 1987, text: "ã€Œçˆ­å–ç™¾åˆ†ä¹‹ç™¾çš„è‡ªç”±ã€‚ã€", author: "â€” é„­å—æ¦•" }
        ];

        const mapConfig = [
            { name: "å°åŒ—è»Šç«™", type: "start", label: "èµ·é»" }, 
            { name: "èŒ¶é¤¨", type: "opportunity", label: "æ©Ÿæœƒ" }, 
            { name: "è¡Œæ”¿å…¬ç½²", type: "danger", damage: 15, confiscate: true, label: "å±éšª", narrative: "ä½ è·¯éè¡Œæ”¿å…¬ç½²ï¼Œç„¡ç«¯è¢«è¡›å…µæ””ä¸‹ç›¤æŸ¥ï¼Œé­æ§æ‰˜é‡æ“Šã€‚" }, 
            { name: "å°ç£å¤§å­¸", type: "safe", heal: 12, label: "å®‰å…¨", narrative: "åœ¨åœ–æ›¸é¤¨çš„è§’è½è£¡ï¼Œä½ è®€è‘—å‰è¼©ç•™ä¸‹çš„è©©å¥ï¼Œå…§å¿ƒç²å¾—äº†å¹³éœã€‚" }, 
            { name: "åœ“å±±é£¯åº—", type: "site", label: "æ™¯é»" },
            { name: "åŸºéš†æ¸¯", type: "danger", damage: 10, label: "å°é–", narrative: "è©¦åœ–é è¿‘æ¸¯å£æŸ¥çœ‹èˆ¹æœŸï¼Œå»è¢«å·¡é‚æ†²å…µé©…è¶•ä¸¦æ¯†æ‰“ã€‚" }, 
            { name: "å ±ç¤¾", type: "opportunity", label: "æ©Ÿæœƒ" }, 
            { name: "é¦¬å ´ç”º", type: "danger", damage: 30, confiscate: true, label: "åˆ‘å ´", narrative: "æ¸…æ™¨çš„æ§éŸ¿åŠƒç ´å¤©éš›ï¼Œè¦ªçœ¼ç›®ç¹çš„è™•æ±ºç•«é¢æˆäº†ä½ æ®ä¹‹ä¸å»çš„å¤¢é­˜ã€‚" }, 
            { name: "æ–°åº—æºª", type: "destiny", label: "å‘½é‹" }, 
            { name: "è­¦å‚™ç¸½éƒ¨", type: "danger", damage: 25, confiscate: true, label: "å±éšª", narrative: "è¢«å¸¶é€²äº†ä»¤äººèé¢¨å–ªè†½çš„åœ°ä¸‹å®¤é€²è¡Œã€Œå–èŒ¶ã€ï¼Œå¼·å…‰ç‡ˆç…§å¾—ä½ ç²¾ç¥å´©æ½°ã€‚" },
            { name: "ç¶ å³¶", type: "jail", label: "ç›£ç„", narrative: "è¢«é€å¾€ç«ç‡’å³¶é€²è¡Œæ€æƒ³æ”¹é€ ã€‚" }, 
            { name: "å˜‰ç¾©è»Šç«™", type: "danger", damage: 15, label: "å±éšª", narrative: "è»Šç«™å‰å…¬é–‹ç¤ºçœ¾çš„éºé«”è®“ä½ æ„Ÿåˆ°æ·±æ·±çš„ææ‡¼èˆ‡ç„¡åŠ›ã€‚" }, 
            { name: "é˜²ç©ºæ´", type: "safe", heal: 12, label: "å®‰å…¨", narrative: "èº²åœ¨æ½®æ¿•é™°æš—çš„é˜²ç©ºæ´è£¡ï¼Œæš«æ™‚é¿é–‹äº†å¤–é ­çš„ç´›æ“¾ã€‚" }, 
            { name: "äºŒä¸ƒéƒ¨éšŠ", type: "site", label: "éºè·¡" }, 
            { name: "é«˜é›„è¦å¡", type: "danger", damage: 15, label: "ç¦å€", narrative: "èª¤é—–è»äº‹ç®¡åˆ¶å€ï¼Œé­åˆ°åš´å²çš„å¯©å•èˆ‡é«”ç½°ã€‚" },
            { name: "ç³–å» ", type: "site", label: "èšé›†" }, 
            { name: "æ·±å¤œå®¶é–€", type: "home", label: "å®¶" }, 
            { name: "å»£æ’­ç«™", type: "destiny", label: "å‘½é‹" }, 
            { name: "é¹¿çªŸ", type: "danger", damage: 20, label: "æœæ•", narrative: "åœ¨å±±å€é­é‡å¤§è¦æ¨¡æœå±±ï¼Œè¢«ç•¶ä½œå«Œç–‘çŠ¯ç²—æš´å°å¾…ã€‚" }, 
            { name: "ç¾åœ‹å¤§ä½¿é¤¨", type: "exit", label: "å‡ºå£" }
        ];

        const rolesData = {
            student: { name: "å­¸ç”Ÿ", color: "#4facfe", icon: "ğŸ“", skill: "ç–¾è¡Œ", skillDesc: "æ“²å…©éª°é¸ä¸€" },
            teacher: { name: "æ•™å¸«", color: "#fbc2eb", icon: "ğŸ‘“", skill: "æ˜å“²", skillDesc: "æŠµæ“‹å±éšª" },
            worker:  { name: "å·¥äºº", color: "#ff9a9e", icon: "ğŸ”¨", skill: "ç¡¬æ°£", skillDesc: "å›è¡€åœä¸€å›" },
            doctor:  { name: "é†«å¸«", color: "#00f260", icon: "âš•ï¸", skill: "è¨ºç™‚", skillDesc: "-5HP æ› +25HP" }
        };

        let game;
        let selectedRoleKey = null;

        function selectRole(role) {
            selectedRoleKey = role;
            document.getElementById('role-select-screen').style.display = 'none';
            document.getElementById('intro-screen').style.display = 'flex';
        }
        function startGame() {
            document.getElementById('intro-screen').style.display = 'none';
            game = new Game(selectedRoleKey);
        }

        class Game {
            constructor(userRoleKey) {
                this.year = 1949;
                this.endYear = 1987;
                this.gameOver = false;
                this.currentPlayerIndex = 0;
                this.players = this.createPlayers(userRoleKey);
                this.initBoard();
                this.updateUI();
                this.updateQuote();
                this.log(`éŠæˆ²é–‹å§‹ã€‚èº«ä»½ï¼š${rolesData[userRoleKey].name}`, "normal");
            }

            createPlayers(userRoleKey) {
                const roleKeys = ['student', 'teacher', 'worker', 'doctor'];
                const aiRoles = roleKeys.filter(k => k !== userRoleKey);
                return [userRoleKey, ...aiRoles].map((key, idx) => ({
                    id: idx, roleId: key, isAI: idx !== 0, pos: 0,
                    hp: key === 'worker' ? 120 : (key === 'teacher' ? 90 : 100),
                    hasVisa: false, skip: 0, status: 'active', sinner: false, betrayalUsed: false,
                    skillCD: 0, buffInvincible: false // Skill properties
                }));
            }

            initBoard() {
                const boardEl = document.getElementById('board');
                boardEl.innerHTML = `
                    <div class="center-area">
                        <div id="year-display" class="year-badge">1949</div>
                        <div id="dice-display">ğŸ²</div>
                        <div class="quote-container" id="quote-container">
                            <div class="quote-text" id="quote-text"></div>
                            <div class="quote-author" id="quote-author"></div>
                        </div>
                    </div>`;
                const posMap = [{r:1,c:1},{r:1,c:2},{r:1,c:3},{r:1,c:4},{r:1,c:5},{r:1,c:6},{r:2,c:6},{r:3,c:6},{r:4,c:6},{r:5,c:6},{r:6,c:6},{r:6,c:5},{r:6,c:4},{r:6,c:3},{r:6,c:2},{r:6,c:1},{r:5,c:1},{r:4,c:1},{r:3,c:1},{r:2,c:1}];
                mapConfig.forEach((tile, index) => {
                    const div = document.createElement('div');
                    div.className = `tile ${tile.type}`;
                    div.style.gridRow = posMap[index].r; div.style.gridColumn = posMap[index].c;
                    let label = tile.type==='opportunity'?'æ©Ÿæœƒ':tile.type==='destiny'?'å‘½é‹':tile.type==='home'?'å®¶':tile.label;
                    let lClass = tile.type==='opportunity'?'label-opp':tile.type==='destiny'?'label-dest':tile.type==='home'?'label-home':'';
                    div.innerHTML = `<div class="tile-label ${lClass}">${label}</div><div class="tile-name">${tile.name}</div><div class="players-container" id="players-${index}"></div>`;
                    boardEl.appendChild(div);
                });
                this.renderPlayers();
            }

            renderPlayers() {
                document.querySelectorAll('.players-container').forEach(el => el.innerHTML = '');
                this.players.forEach(p => {
                    if (p.status !== 'active') return;
                    const container = document.getElementById(`players-${p.pos}`);
                    const token = document.createElement('div');
                    token.className = `token ${p.hasVisa ? 'has-visa' : ''}`;
                    token.style.background = rolesData[p.roleId].color;
                    token.style.borderColor = p.id === this.currentPlayerIndex ? '#fff' : 'rgba(255,255,255,0.5)';
                    token.style.zIndex = p.id === this.currentPlayerIndex ? 10 : 1;
                    token.innerHTML = rolesData[p.roleId].icon;
                    container.appendChild(token);
                });
            }

            updateQuote() {
                const candidates = quoteLibrary.filter(q => this.year >= q.min && this.year <= q.max);
                const q = candidates.length > 0 ? candidates[Math.floor(Math.random() * candidates.length)] : {text: "...", author: ""};
                document.getElementById('quote-text').innerText = q.text;
                document.getElementById('quote-author').innerText = q.author;
            }

            updateUI() {
                const progress = Math.min(100, ((this.year - 1949) / (this.endYear - 1949)) * 100);
                document.getElementById('timeline-bar').style.width = `${progress}%`;
                document.getElementById('year-display').innerText = this.year;
                const statusPanel = document.getElementById('player-status');
                statusPanel.innerHTML = '';
                this.players.forEach((p, idx) => {
                    const r = rolesData[p.roleId];
                    let sClass = p.status==='escaped'?'escaped':p.status==='survived'?'survived':p.status==='dead'?'eliminated':idx===this.currentPlayerIndex?'active':'';
                    let hpTxt = p.status==='active'?`HP: ${p.hp}`:(p.status==='escaped'?'æµäº¡':(p.status==='survived'?'å€–å­˜':'çŠ§ç‰²'));
                    let sinnerTag = p.sinner ? `<span class="is-sinner">ç½ªäºº</span>` : '';
                    let buffIcon = p.buffInvincible ? `<span title="ç„¡æ•µç›¾">ğŸ›¡ï¸</span>` : '';
                    statusPanel.innerHTML += `
                        <div class="player-card ${sClass}">
                            <div style="font-size:18px;">${r.icon}</div>
                            <div>
                                <div style="font-weight:bold;color:${r.color}">${r.name} ${p.isAI?'<span class="is-ai">AI</span>':'(ä½ )'}${sinnerTag}${buffIcon}</div>
                                <div style="font-size:11px;color:#aaa;">${p.hasVisa && p.status==='active'?'ğŸ« æŒæœ‰è­‰ä»¶':''}</div>
                            </div>
                            <div style="font-weight:bold;text-align:right">${hpTxt}</div>
                        </div>`;
                });

                // Skill Button State
                const p = this.players[0];
                const btn = document.getElementById('skill-btn');
                const r = rolesData[p.roleId];
                document.getElementById('skill-name').innerText = `æŠ€èƒ½: ${r.skill}`;
                if (p.skillCD > 0) {
                    btn.disabled = true;
                    document.getElementById('skill-desc').innerText = `å†·å»ä¸­ (${p.skillCD})`;
                } else if (p.status !== 'active') {
                    btn.disabled = true;
                    document.getElementById('skill-desc').innerText = `ç„¡æ³•ä½¿ç”¨`;
                } else {
                    btn.disabled = false;
                    document.getElementById('skill-desc').innerText = r.skillDesc;
                }
            }

            log(msg, type = 'normal') {
                const box = document.getElementById('game-log');
                box.insertAdjacentHTML('afterbegin', `<div class="log-entry ${type}">${msg}</div>`);
            }

            humanPlay() {
                const p = this.players[0];
                if (this.gameOver || p.status !== 'active') return;
                document.getElementById('roll-btn').disabled = true;
                document.getElementById('skill-btn').disabled = true;
                this.executeTurn(p);
            }

            // --- Skill Logic ---
            useSkill() {
                const p = this.players[0];
                if (p.skillCD > 0) return;
                
                const r = rolesData[p.roleId];
                p.skillCD = 7; // Base CD = 7
                
                // Narrative for skill
                let narrative = "";
                if(p.roleId === 'student') narrative = "ç„¦æ€¥åœ°æƒ³è¦æ“ºè„«å›°å¢ƒã€‚";
                if(p.roleId === 'teacher') narrative = "å—…åˆ°äº†ç©ºæ°£ä¸­çš„å±éšªã€‚";
                if(p.roleId === 'worker') narrative = "å’¬ç‰™æ’ä½èº«é«”çš„å‚·ç—›ã€‚";
                if(p.roleId === 'doctor') narrative = "å†·éœåœ°è™•ç†èº«ä¸Šçš„å‚·å£ã€‚";
                
                this.log(`[æŠ€èƒ½] ${narrative} ç™¼å‹•ã€Œ${r.skill}ã€ï¼`, "log-skill");

                if (p.roleId === 'student') {
                    const d1 = Math.floor(Math.random() * 6) + 1;
                    const d2 = Math.floor(Math.random() * 6) + 1;
                    const steps = Math.max(d1, d2);
                    this.log(`[æŠ€èƒ½] ç–¾è¡Œçˆ†ç™¼ï¼æ“²å‡º ${d1} èˆ‡ ${d2}ï¼Œé¸æ“‡ ${steps} æ­¥ã€‚`, "log-skill");
                    document.getElementById('roll-btn').disabled = true;
                    document.getElementById('skill-btn').disabled = true;
                    document.getElementById('dice-display').innerText = `ğŸ² ${steps}`;
                    this.movePlayer(p, steps);
                } else if (p.roleId === 'teacher') {
                    p.buffInvincible = true;
                    this.log(`[æŠ€èƒ½] æ˜å“²ä¿èº«é–‹å•Ÿã€‚ä¸‹ä¸€æ¬¡é­é‡å±éšªæ™‚å‚·å®³ç„¡æ•ˆã€‚`, "log-skill");
                    this.updateUI();
                } else if (p.roleId === 'worker') {
                    p.hp = Math.min(120, p.hp + 15);
                    p.skip = 1;
                    this.log(`[æŠ€èƒ½] ç¡¬æ°£å›å¾©ï¼(+15 HP)ï¼Œä½†éœ€ä¼‘æ¯ä¸€å›åˆã€‚`, "log-skill");
                    this.updateUI();
                    this.checkNextPlayer(); 
                } else if (p.roleId === 'doctor') {
                    p.hp -= 5;
                    p.hp = Math.min(100, p.hp + 25);
                    this.log(`[æŠ€èƒ½] ç·Šæ€¥è¨ºç™‚ã€‚æ¶ˆè€—é«”åŠ›(-5) æ›å–å¤§å¹…å›å¾©(+25) = +20 HPã€‚`, "log-skill");
                    this.updateUI();
                }
            }

            checkNextPlayer() {
                if (this.gameOver) return;
                let nextIdx = (this.currentPlayerIndex + 1) % 4;
                let safety = 0;
                while (this.players[nextIdx].status !== 'active' && safety < 4) { nextIdx = (nextIdx + 1) % 4; safety++; }
                if (safety >= 4) { this.checkGameEnd(); return; }
                this.currentPlayerIndex = nextIdx;
                const nextP = this.players[nextIdx];
                
                // Cooldown reduction
                if (nextP.skillCD > 0) nextP.skillCD--;

                this.updateUI();
                this.renderPlayers();
                
                if (nextP.isAI) {
                    document.getElementById('roll-btn').disabled = true;
                    document.getElementById('skill-btn').disabled = true; 
                    document.getElementById('roll-btn').innerText = `ç­‰å¾… ${rolesData[nextP.roleId].name}...`;
                    
                    // AI Skill Logic
                    if (nextP.skillCD === 0 && nextP.hp < 40 && Math.random() < 0.5) {
                         this.aiUseSkill(nextP);
                    } else {
                        setTimeout(() => this.executeTurn(nextP), 1000);
                    }
                } else {
                    document.getElementById('roll-btn').disabled = false;
                    document.getElementById('roll-btn').innerText = `ğŸ² æ“²éª°å­`;
                    this.updateUI(); 
                }
            }

            aiUseSkill(p) {
                 const r = rolesData[p.roleId];
                 p.skillCD = 7; // CD=7
                 
                 let narrative = "";
                 if(p.roleId === 'student') narrative = "ç„¦æ€¥åœ°æƒ³è¦æ“ºè„«å›°å¢ƒã€‚";
                 if(p.roleId === 'teacher') narrative = "å—…åˆ°äº†ç©ºæ°£ä¸­çš„å±éšªã€‚";
                 if(p.roleId === 'worker') narrative = "å’¬ç‰™æ’ä½èº«é«”çš„å‚·ç—›ã€‚";
                 if(p.roleId === 'doctor') narrative = "å†·éœåœ°è™•ç†èº«ä¸Šçš„å‚·å£ã€‚";

                 this.log(`[${r.name}] ${narrative} ç™¼å‹•æŠ€èƒ½ã€Œ${r.skill}ã€`, "log-skill");
                 if (p.roleId === 'doctor' || p.roleId === 'worker') {
                     if (p.roleId === 'doctor') p.hp = Math.min(100, p.hp + 20);
                     if (p.roleId === 'worker') { p.hp += 15; p.skip = 1; }
                     this.updateUI();
                     if (p.skip > 0) this.checkNextPlayer();
                     else setTimeout(() => this.executeTurn(p), 1000);
                 } else {
                     setTimeout(() => this.executeTurn(p), 1000);
                 }
            }

            executeTurn(p) {
                if (p.skip > 0) {
                    p.skip--;
                    this.log(`${p.isAI?`[${rolesData[p.roleId].name}]`:'[ä½ ]'} æš«åœè¡Œå‹• (${p.skip})`, "log-ai-action");
                    this.checkNextPlayer();
                    return;
                }
                const steps = Math.floor(Math.random() * 6) + 1;
                document.getElementById('dice-display').innerText = `ğŸ² ${steps}`;
                this.movePlayer(p, steps);
            }

            movePlayer(player, steps) {
                player.pos = (player.pos + steps) % 20;
                if (player.pos < steps) { 
                    // Only advance year if NOT frozen at 1987
                    if (this.year < 1987) {
                        this.year += 3;
                        if (this.year > 1987) this.year = 1987;
                        this.updateQuote();
                        if(!player.isAI) this.log(`ç¶“éèµ·é»ï¼Œæ™‚å…‰æµé€ (${this.year})`, "normal");
                    } else {
                        if(!player.isAI) this.log(`ç¶“éèµ·é»ï¼Œé»æ˜å°‡è‡³...`, "normal");
                    }
                    player.hp = Math.min(100, player.hp + 10); 
                }
                
                // History Events Logic (Queue system)
                let eventTriggered = false;
                // First check for missed events up to current year
                for(let ev of historicalEvents) {
                    if (!ev.trigger && ev.year <= this.year) {
                        this.triggerHistoryEvent(ev);
                        eventTriggered = true;
                        ev.trigger = true;
                        break; 
                    }
                }

                if (!eventTriggered) {
                    if (this.checkGameEnd()) return; // Only end if 1987 AND no events left
                    this.renderPlayers();
                    
                    // Check Encounters
                    const others = this.players.filter(op => op.id !== player.id && op.status === 'active' && op.pos === player.pos);
                    if (others.length > 0 && !player.isAI) {
                        this.triggerEncounter(player, others[0]);
                    } else if (others.length > 0 && player.isAI) {
                        this.resolveAIEncounter(player, others[0]);
                        this.triggerTileEffect(player); 
                    } else {
                        this.triggerTileEffect(player);
                    }
                }
            }

            // --- Encounter System ---
            triggerEncounter(player, other) {
                this.pendingEncounter = { player, other };
                document.getElementById('encounter-text').innerText = `ä½ åœ¨ ${mapConfig[player.pos].name} é‡åˆ°äº† ${rolesData[other.roleId].name}ã€‚`;
                document.getElementById('encounter-avatars').innerHTML = `<div>${rolesData[player.roleId].icon}</div><div>${rolesData[other.roleId].icon}</div>`;
                document.getElementById('encounter-modal').style.display = 'block'; 
            }

            resolveEncounter(tryConnect) {
                document.getElementById('encounter-modal').style.display = 'none';
                const p = this.pendingEncounter.player;
                const o = this.pendingEncounter.other;
                
                if (tryConnect) {
                    // Whisper logic
                    const isComrade = Math.random() < 0.6; // 60% chance comrade
                    if (isComrade) {
                        p.hp = Math.min(100, p.hp + 10); // Adjusted to +10
                        o.hp = Math.min(100, o.hp + 10); // Adjusted to +10
                        this.log(`[è©¦æ¢] çœ¼ç¥äº¤æœƒï¼Œç¢ºèªæ˜¯åŒå¿—ï¼ç²å¾—å¿ƒéˆæ…°è—‰ (+10 HP)`, "log-good");
                    } else {
                        p.hp -= 20;
                        this.log(`[è©¦æ¢] å°æ–¹çœ¼ç¥é–ƒçˆï¼Œå¯èƒ½æ˜¯ç·šæ°‘ï¼ä½ è¶•ç·Šé€ƒé›¢ï¼Œé©šé­‚æœªå®š (-20 HP)`, "log-bad");
                    }
                } else {
                    // Avoid logic
                    p.hp = Math.min(100, p.hp + 5);
                    this.log(`[è¿´é¿] ä½ é¸æ“‡ä½é ­å¿«æ­¥é›¢é–‹ã€‚åœ¨é€™å€‹æ™‚ä»£ï¼Œæ²ˆé»˜æ˜¯æœ€å®‰å…¨çš„ (+5 HP)`, "normal");
                }
                this.updateUI();
                this.triggerTileEffect(p);
            }

            // AI vs AI Narrative
            resolveAIEncounter(p, o) {
                if (Math.random() < 0.5) {
                    // Connect
                    if (Math.random() < 0.6) {
                        p.hp = Math.min(100, p.hp + 10); 
                        o.hp = Math.min(100, o.hp + 10); 
                        this.log(`[ç›¸é‡] ${rolesData[p.roleId].name} èˆ‡ ${rolesData[o.roleId].name} äº¤æ›äº†ç§˜å¯†ä¿¡ä»¶ï¼Œäº’ç›¸æ‰“æ°£ã€‚`, "log-ai-good");
                    } else {
                        p.hp -= 20;
                        this.log(`[ç›¸é‡] ${rolesData[p.roleId].name} è©¦åœ–æ¥è¿‘ ${rolesData[o.roleId].name}ï¼Œä½†è¢«å°æ–¹èª¤æœƒè€Œç™¼ç”Ÿè¡çªã€‚`, "log-ai-bad");
                    }
                } else {
                    // Avoid
                    this.log(`[ç›¸é‡] ${rolesData[p.roleId].name} é é çœ‹åˆ°äº† ${rolesData[o.roleId].name}ï¼Œä½†é¸æ“‡ç¹é“è€Œè¡Œã€‚`, "log-ai-action");
                }
                this.updateUI();
            }

            triggerTileEffect(player) {
                const tile = mapConfig[player.pos];
                const rName = rolesData[player.roleId].name;
                const prefix = player.isAI ? `[${rName}]` : `[ä½ ]`;

                if (tile.type === 'home') {
                    const rand = Math.random();
                    if (rand < 0.85) { 
                        player.hp = Math.min(100, player.hp + 15);
                        this.log(`${prefix} å›åˆ°å®¶ä¸­é–ä¸Šé–€ï¼Œæš«æ™‚æ„Ÿåˆ°ä¸€çµ²å®‰å¿ƒã€‚ (+15 HP)`, player.isAI ? "log-ai-action" : "good");
                    } else {
                        this.log(`${prefix} å›å®¶æ™‚ç™¼ç¾é–€å£è²¼è‘—å°æ¢ï¼è¢«åŸ‹ä¼çš„ç‰¹å‹™å¼·è¡Œå¸¶èµ°ï¼`, "log-home-bad");
                        player.pos = 9; player.hp -= 15; 
                        if (player.hasVisa) { player.hasVisa = false; this.log(`${prefix} ç°½è­‰åœ¨åµè¨Šä¸­è¢«æ²’æ”¶äº†ï¼`, "bad"); }
                        this.renderPlayers();
                    }
                }
                else if (tile.type === 'opportunity' || tile.type === 'destiny') {
                    const candidates = dilemmas.filter(d => d.type === tile.type);
                    const dilemma = candidates[Math.floor(Math.random() * candidates.length)];
                    if (player.isAI) {
                        this.resolveDilemma(player, dilemma, Math.random() < 0.3);
                    } else {
                        this.showChoiceModal(dilemma);
                    }
                    return; 
                }
                else if (tile.type === 'exit') {
                    if (player.hasVisa) {
                        player.status = 'escaped';
                        this.log(`âœˆï¸ ${rName} æˆåŠŸç™»æ©Ÿï¼Œåœ¨æœ€å¾Œä¸€åˆ»æµäº¡æµ·å¤–ï¼`, "win");
                        if (!player.isAI) { this.showEscapeScreen(); return; }
                    } else if(!player.isAI) this.log(`æ²’æœ‰å‡ºå¢ƒè­‰ä»¶ï¼Œç„¡æ³•é€šé—œã€‚`, "bad");
                }
                else if ((tile.confiscate || tile.type === 'jail') && player.hasVisa) {
                    player.hasVisa = false;
                    this.log(`âš ï¸ ${rName} é­åˆ°æœèº«ï¼Œå¥½ä¸å®¹æ˜“è—å¥½çš„ [å‡ºå¢ƒè­‰] è¢«æœå‡ºæ’•æ¯€ï¼`, "bad");
                }
                else if (tile.type === 'jail') {
                    player.skip = 2;
                    const narr = tile.narrative || "è¢«é€å¾€ç¶ å³¶é€²è¡Œæ„ŸåŒ–æ•™è‚²ã€‚";
                    this.log(`${prefix} ${narr}`, "bad");
                } 
                else if (tile.damage) {
                    if (player.buffInvincible) {
                         player.buffInvincible = false;
                         this.log(`${prefix} åˆ©ç”¨ [æ˜å“²] æŠ€èƒ½ï¼Œé©šéšªåœ°é¿é–‹äº† ${tile.name} çš„å±éšªï¼`, "log-skill");
                         this.updateUI();
                    } else {
                        player.hp -= tile.damage;
                        const narr = tile.narrative || "å—åˆ°å‚·å®³ã€‚";
                        this.log(`${prefix} ${narr} (-${tile.damage})`, player.isAI ? "log-ai-bad" : "bad");
                    }
                }
                else if (tile.heal) {
                    player.hp = Math.min(100, player.hp + tile.heal);
                    const narr = tile.narrative || "ç¨ä½œä¼‘æ¯ã€‚";
                    this.log(`${prefix} ${narr} (+${tile.heal} HP)`, player.isAI ? "log-ai-action" : "good");
                }

                this.postActionCheck(player);
            }

            triggerHistoryEvent(event) {
                document.getElementById('hist-year').innerText = event.year;
                document.getElementById('hist-title').innerText = event.title;
                document.getElementById('hist-desc').innerText = event.desc;
                this.pendingEvent = event; 
                document.getElementById('hist-effect').innerText = "å…¨é«”ç©å®¶å°‡å—åˆ°æ­·å²è¡æ“Š...";
                document.getElementById('history-modal').style.display = 'flex';
            }
            closeHistoryModal() {
                document.getElementById('history-modal').style.display = 'none';
                const event = this.pendingEvent;
                this.log(`ã€æ­·å²å¤§äº‹ã€‘${event.title} çˆ†ç™¼ï¼`, "log-event");
                this.players.forEach(p => {
                    if(p.status === 'active') {
                        const msg = event.apply(p);
                        this.log(`[${rolesData[p.roleId].name}] ${msg}`, p.isAI ? "log-ai-bad" : "bad");
                    }
                });
                this.updateUI();
                this.checkGameEnd(); 
                this.triggerTileEffect(this.players[this.currentPlayerIndex]);
            }

            showChoiceModal(dilemma) {
                this.currentDilemma = dilemma;
                document.getElementById('choice-title').innerText = dilemma.title;
                document.getElementById('choice-desc').innerText = dilemma.desc;
                document.getElementById('btn-risk').onclick = () => { document.getElementById('choice-modal').style.display='none'; this.resolveDilemma(this.players[0], dilemma, true); };
                document.getElementById('risk-text').innerText = dilemma.optA.text;
                document.getElementById('risk-sub').innerText = `é¢¨éšª: ${dilemma.optA.risk * 100}%`;
                document.getElementById('btn-safe').onclick = () => { document.getElementById('choice-modal').style.display='none'; this.resolveDilemma(this.players[0], dilemma, false); };
                document.getElementById('safe-text').innerText = dilemma.optB.text;
                document.getElementById('safe-sub').innerText = `é¢¨éšª: ${dilemma.optB.risk * 100}%`;
                document.getElementById('choice-modal').style.display = 'flex';
            }
            resolveDilemma(player, dilemma, chooseRisk) {
                const opt = chooseRisk ? dilemma.optA : dilemma.optB;
                const isFail = Math.random() < opt.risk;
                const result = isFail ? opt.fail : opt.success;
                player.hp += result.effect;
                if (result.visa) player.hasVisa = true;
                
                const rName = rolesData[player.roleId].name;
                const prefix = player.isAI ? `[${rName}]` : `[æŠ‰æ“‡]`;
                let narrative = result.narrative;
                
                if (player.isAI) {
                    if(chooseRisk) {
                        if(isFail) narrative = `æ±ºå®šå†’éšªä¸€æ... ä½†é‹æ°£ä¸åœ¨ä»–é€™é‚Šã€‚${result.narrative}`;
                        else narrative = `é¼“èµ·å‹‡æ°£é¸æ“‡äº†é¢¨éšª... ç«Ÿç„¶æˆåŠŸäº†ï¼${result.narrative}`;
                    } else {
                        narrative = `çŒ¶è±«å†ä¸‰ï¼Œæœ€å¾Œé¸æ“‡äº†ä¿å®ˆçš„é“è·¯ã€‚${result.narrative}`;
                    }
                } else {
                    narrative = `${chooseRisk ? "ä½ å†’éšªå˜—è©¦..." : "ä½ é¸æ“‡ä¿å®ˆ..."} ${result.narrative}`;
                }

                this.log(`${prefix} ${narrative} (${result.effect})`, result.effect<0?"bad": result.effect>0?"good":"normal");
                this.postActionCheck(player);
            }
            
            showEscapeScreen() { document.getElementById('escape-modal').style.display = 'flex'; }
            closeEscapeModal() { document.getElementById('escape-modal').style.display = 'none'; this.checkNextPlayer(); }

            resolveBetrayal(doBetray) {
                document.getElementById('betrayal-modal').style.display = 'none';
                const p = this.players[0];
                p.betrayalUsed = true;
                if (doBetray) {
                    p.hp = 40; p.sinner = true;
                    this.log(`[è‰¯å¿ƒ] ä½ é¡«æŠ–è‘—å¯«ä¸‹åå–®... èª¿æŸ¥å®˜å¾®ç¬‘äº†ã€‚ (+40 HP)`, "log-betray");
                } else {
                    if (Math.random() < 0.7) { p.hp = 0; this.log(`[è‰¯å¿ƒ] ä½ å’¬ç·Šç‰™é—œå¯§æ­»ä¸å±ˆã€‚æ¥è‘—æ˜¯æ§è²...`, "bad"); }
                    else { p.hp = 30; this.log(`[è‰¯å¿ƒ] å¥‡è¹Ÿèˆ¬æŒºéäº†é…·åˆ‘ï¼Œæ„å¿—åŠ›è®“ä½ å­˜æ´»ï¼ (+30 HP)`, "log-good"); }
                }
                this.postActionCheck(p);
            }

            postActionCheck(player) {
                if (player.hp <= 0 && !player.betrayalUsed && player.status === 'active') {
                    if (!player.isAI) {
                        player.hp = 1; document.getElementById('betrayal-modal').style.display = 'flex'; return;
                    } else {
                        player.betrayalUsed = true;
                        if (Math.random() < 0.5) { player.hp = 40; player.sinner = true; this.log(`[${rolesData[player.roleId].name}] åœ¨é…·åˆ‘ä¸‹å´©æ½°ï¼Œä¾›å‡ºåŒå¤¥ä¿å‘½...`, "log-betray"); }
                        else { if(Math.random()<0.7) player.hp=0; else { player.hp=30; this.log(`[${rolesData[player.roleId].name}] å¯§æ­»ä¸å±ˆï¼ŒæŒºéé…·åˆ‘ï¼`, "log-ai-good"); } }
                    }
                }
                if (player.hp <= 0) { 
                    player.hp = 0; 
                    player.status = 'dead'; 
                    this.log(`ğŸ’€ ${rolesData[player.roleId].name} å¾æ­¤ä¸‹è½ä¸æ˜...`, "bad"); 
                    if (!player.isAI) {
                        this.gameOver = true;
                        setTimeout(() => { document.getElementById('death-modal').style.display = 'flex'; }, 1000);
                        return;
                    }
                }
                this.updateUI();
                if(!this.checkGameEnd()) this.checkNextPlayer();
            }

            checkGameEnd() {
                if (this.players.every(p => p.status !== 'active')) {
                    this.gameOver = true; document.getElementById('roll-btn').innerText = "éŠæˆ²çµæŸ"; return true;
                }
                
                const remainingEvents = historicalEvents.filter(e => !e.trigger);
                
                if (this.year >= 1987 && remainingEvents.length === 0) {
                    this.players.forEach(p => { if(p.status==='active') p.status='survived'; });
                    this.gameOver = true; this.updateUI();
                    const p = this.players[0];
                    let content = `<p>æ­·ç¶“äº†38å¹´çš„æ¼«é•·é»‘å¤œï¼Œæˆ’åš´ä»¤çµ‚æ–¼å®£å‘Šè§£é™¤ã€‚</p>`;

                    if (p.sinner) {
                        content += `
                        <p style="color:#ff6b6b; font-weight:bold; font-size:20px; margin-top:15px;">ä½ æ´»ä¸‹ä¾†äº†ï¼Œä½†éˆé­‚å·²æ­»ã€‚</p>
                        <hr style="border-color:#555; margin:20px 0; opacity:0.5;">
                        <p style="color:#ddd; font-size:16px; text-align:justify;">
                            ç•¶æ•´åº§å³¶å¶¼åœ¨æ…¶ç¥è‡ªç”±æ™‚ï¼Œ<br>
                            ä½ æƒ³èµ·äº†ç•¶å¹´é‚£å¼µå¯«æ»¿åå­—çš„ç´™æ¢ã€‚<br>
                            é‚£äº›è¢«ä½ å‡ºè³£çš„æ‘¯å‹ï¼Œå†ä¹Ÿæ²’æœ‰å›ä¾†ã€‚<br><br>
                            æ­¡å‘¼è²è¶Šå¤§ï¼Œä½ å¿ƒä¸­çš„å¯©åˆ¤å°±è¶Šéœ‡è€³æ¬²è¾ã€‚<br>
                            é€™ä»½æ„§ç–šï¼Œæ˜¯ä½ é¤˜ç”Ÿå”¯ä¸€çš„è¡Œæã€‚
                        </p>`;
                    } else if (p.status === 'escaped') {
                        content += `
                        <p style="color:#4facfe; font-weight:bold; font-size:20px; margin-top:15px;">æµäº¡æ­²æœˆçš„çµ‚çµã€‚</p>
                        <hr style="border-color:#555; margin:20px 0; opacity:0.5;">
                        <p style="color:#ccc; font-size:16px;">
                            ä½ åœ¨æµ·å¤–è½åˆ°äº†è§£åš´çš„æ¶ˆæ¯ã€‚<br>
                            æ•…é„‰å·²è®Šäº†æ¨£ï¼Œç™½é«®å·²ç”Ÿï¼Œ<br>
                            ä½†ä½ çµ‚æ–¼å¯ä»¥å›å®¶äº†ã€‚
                        </p>`;
                    } else {
                        content += `
                        <p style="color:#c5a059; text-align:center; font-size:20px;">ä½ å•å¿ƒç„¡æ„§åœ°æ´»ä¸‹ä¾†äº†ã€‚</p>
                        <hr style="border-color:#555; margin:20px 0; opacity:0.5;">`;
                    }

                    content += `
                        <p style="color:#bbb; font-size:16px;">
                            ç„¶è€Œï¼Œé€™ä¸¦éè‡ªç”±çš„çµ‚é»ã€‚<br><br>
                            <span class="ending-highlight">åˆ‘æ³•100æ¢</span> ä»ç®åˆ¶è‘—æ€æƒ³ï¼Œ<br>
                            <span class="ending-highlight">è¬å¹´åœ‹æœƒ</span> ä¾èˆŠæŠŠæŒè‘—æ¬ŠåŠ›ã€‚<br><br>
                            å¿ƒä¸­çš„è­¦ç¸½å°šæœªé›¢å»ã€‚<br>
                            é»æ˜é›–ç„¶åˆ°ä¾†ï¼Œä½†æˆ°é¬¥æ‰æ­£è¦é–‹å§‹ã€‚
                        </p>`;

                    document.getElementById('ending-content').innerHTML = content;
                    document.getElementById('ending-screen').style.display = 'flex';
                    return true;
                }
                return false;
            }
        }
    </script>
</body>
</html>