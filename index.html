<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ²ˆé»˜ä¹‹å³¶ï¼šæ–‡å­—å†’éšªç‰ˆ</title>
    <style>
        :root {
            --bg-color: #111;
            --text-color: #ccc;
            --highlight: #c5a059;
            --danger: #8a1c1c;
            --success: #3d6647;
            --card-bg: #1f1f1f;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Courier New", "Kaiti TC", serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- é ‚éƒ¨ç‹€æ…‹æ¬„ --- */
        .header {
            padding: 15px;
            background: #000;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .year-display { font-size: 28px; font-weight: 900; color: #555; font-family: Impact, sans-serif; }
        .year-active { color: var(--highlight); }
        
        .status-display { text-align: right; font-size: 14px; }
        .hp-bar-container { width: 100px; height: 6px; background: #333; margin-top: 5px; border-radius: 3px; }
        .hp-bar-fill { height: 100%; background: var(--danger); width: 100%; transition: width 0.5s; }

        /* --- ä¸­é–“åŠ‡æƒ…å€ (å¯æ»¾å‹•) --- */
        .narrative-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }

        .event-card {
            background: var(--card-bg);
            padding: 20px;
            border-left: 4px solid #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            animation: slideUp 0.6s ease-out;
        }
        .event-title { font-size: 20px; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .event-desc { font-size: 16px; line-height: 1.8; text-align: justify; color: #ddd; }
        
        /* æ­·å²äº‹ä»¶ç‰¹åˆ¥æ¨£å¼ */
        .event-card.history { border-left-color: var(--highlight); background: #2a2218; }
        .event-card.history .event-title { color: var(--highlight); }

        /* çµæœå›é¥‹æ¨£å¼ */
        .result-box { 
            padding: 15px; margin-top: 10px; border-radius: 4px; font-size: 14px; 
            animation: fadeIn 0.5s; display: none;
        }
        .result-success { background: rgba(61, 102, 71, 0.3); border: 1px solid var(--success); color: #8f8; }
        .result-fail { background: rgba(138, 28, 28, 0.3); border: 1px solid var(--danger); color: #f88; }
        .dice-roll { font-weight: bold; font-size: 18px; margin-right: 10px; }

        /* --- åº•éƒ¨æ§åˆ¶å€ --- */
        .controls {
            padding: 20px;
            background: #000;
            border-top: 1px solid #333;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 15px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .choice-btn:hover, .choice-btn:active { background: #444; border-color: #888; }
        .choice-tag { font-size: 12px; padding: 2px 6px; border-radius: 2px; background: #000; color: #aaa; }
        
        .btn-continue { 
            background: var(--highlight); color: #000; font-weight: bold; text-align: center; justify-content: center;
            display: none; /* é è¨­éš±è— */
        }

        /* --- è§’è‰²é¸æ“‡ --- */
        #start-screen, #end-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; text-align: center;
        }
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .role-card {
            background: #1a1a1a; border: 1px solid #444; padding: 15px;
            cursor: pointer; border-radius: 5px; transition: 0.2s;
        }
        .role-card:active { background: #333; transform: scale(0.95); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:var(--danger); font-size:36px; margin-bottom:10px;">æ²ˆé»˜ä¹‹å³¶</h1>
        <p style="color:#888; margin-bottom:30px;">æ–‡å­—å†’éšªç‰ˆ v30.0</p>
        <p style="margin-bottom:20px;">è«‹é¸æ“‡ä½ çš„å‘½é‹ï¼š</p>
        <div class="role-grid">
            <div class="role-card" onclick="startGame('student')">
                <div style="font-size:40px">ğŸ“</div>
                <div style="color:#4facfe; font-weight:bold;">å­¸ç”Ÿ</div>
                <div style="font-size:12px; color:#aaa;">ç‰¹é•·ï¼šé€ƒè·‘ (ç–¾è¡Œ)</div>
            </div>
            <div class="role-card" onclick="startGame('teacher')">
                <div style="font-size:40px">ğŸ‘“</div>
                <div style="color:#fbc2eb; font-weight:bold;">æ•™å¸«</div>
                <div style="font-size:12px; color:#aaa;">ç‰¹é•·ï¼šæ´å¯Ÿ (æ˜å“²)</div>
            </div>
            <div class="role-card" onclick="startGame('worker')">
                <div style="font-size:40px">ğŸ”¨</div>
                <div style="color:#ff9a9e; font-weight:bold;">å·¥äºº</div>
                <div style="font-size:12px; color:#aaa;">ç‰¹é•·ï¼šé«”åŠ› (ç¡¬æ°£)</div>
            </div>
            <div class="role-card" onclick="startGame('doctor')">
                <div style="font-size:40px">âš•ï¸</div>
                <div style="color:#00f260; font-weight:bold;">é†«å¸«</div>
                <div style="font-size:12px; color:#aaa;">ç‰¹é•·ï¼šæ²»ç™‚ (äººè„ˆ)</div>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="year-display" id="year-text">1949</div>
        <div class="status-display">
            <div id="role-display">è§’è‰²: å­¸ç”Ÿ</div>
            <div class="hp-bar-container">
                <div class="hp-bar-fill" id="hp-bar"></div>
            </div>
            <div id="hp-text" style="font-size:10px; color:#aaa;">HP: 100</div>
        </div>
    </div>

    <div class="narrative-container" id="story-board">
        </div>

    <div class="controls" id="control-panel">
        </div>

    <div id="end-screen" style="display:none;">
        <h1 id="end-title" style="color:var(--highlight); margin-bottom:20px;"></h1>
        <div id="end-desc" style="text-align: justify; color:#ddd; line-height:1.8; max-width:500px;"></div>
        <button class="choice-btn btn-continue" style="display:block; margin-top:30px; width:100%;" onclick="location.reload()">éŠ˜è¨˜æ­·å² (é‡ä¾†)</button>
    </div>

    <script>
        // --- éŠæˆ²æ•¸æ“š ---
        const roles = {
            student: { name: "å­¸ç”Ÿ", hp: 100, bonus: "run" }, // é€ƒè·‘æª¢å®šå„ªå‹¢
            teacher: { name: "æ•™å¸«", hp: 90, bonus: "detect" }, // è§€å¯Ÿæª¢å®šå„ªå‹¢
            worker: { name: "å·¥äºº", hp: 120, bonus: "endure" }, // æ‰¿å—å‚·å®³å„ªå‹¢
            doctor: { name: "é†«å¸«", hp: 100, bonus: "social" } // ç¤¾äº¤/è³„è³‚å„ªå‹¢
        };

        // éš¨æ©Ÿäº‹ä»¶åº« (éæ­·å²äº‹ä»¶)
        const randomEvents = [
            {
                title: "æ·±å¤œæ•²é–€",
                desc: "åŠå¤œå‚³ä¾†æ€¥ä¿ƒçš„æ•²é–€è²ï¼Œä¸€å€‹æ°£å–˜ååçš„é™Œç”Ÿäººæ±‚ä½ è®“ä»–èº²ä¸€æ™šã€‚ä»–èº«ä¸Šæœ‰è¡€è…¥å‘³ã€‚",
                choices: [
                    { text: "é–‹é–€è—åŒ¿", type: "check", difficulty: 4, skill: "social", 
                      success: { msg: "ä½ æˆåŠŸè—åŒ¿äº†ä»–ï¼Œä»–ç•™ä¸‹ä¸€å€‹è¯çµ¡æš—è™Ÿä½œç‚ºå›å ±ã€‚", hp: 10 },
                      fail: { msg: "æ˜¯é™·é˜±ï¼ç‰¹å‹™éš¨å¾Œè¡å…¥ï¼Œä½ è¢«æ¯’æ‰“ä¸€é “ã€‚", hp: -20 } },
                    { text: "ç†„ç‡ˆè£ç¡", type: "safe", 
                      result: { msg: "æ•²é–€è²æŒçºŒäº†ä¸€é™£å¾Œæ¶ˆå¤±ã€‚éš”å¤©ä½ åœ¨æ²³é‚Šçœ‹åˆ°äº†å±é«”ï¼Œè‰¯å¿ƒå—åˆ°è­´è²¬ã€‚", hp: -5 } }
                ]
            },
            {
                title: "éºè½çš„ç¦æ›¸",
                desc: "åœ¨å…¬åœ’é•·æ¤…ä¸Šï¼Œæœ‰äººéºè½äº†ä¸€æœ¬ã€Šç‹‚äººæ—¥è¨˜ã€‹ã€‚é€™åœ¨ç•¶ä¸‹æ˜¯çµ•å°çš„ç¦æ›¸ã€‚",
                choices: [
                    { text: "æ’¿èµ°é–±è®€", type: "check", difficulty: 5, skill: "detect",
                      success: { msg: "ä½ è¿…é€Ÿå°‡æ›¸è—å…¥æ‡·ä¸­ã€‚æ›¸ä¸­çš„æ–‡å­—è®“ä½ ç²¾ç¥å¤§æŒ¯ã€‚", hp: 15 },
                      fail: { msg: "ä¾¿è¡£è­¦å¯Ÿä¸€ç›´åœ¨æ—é‚Šç›¯è‘—ï¼ä½ å‰›ç¢°åˆ°æ›¸å°±è¢«æŒ‰åœ¨åœ°ä¸Šã€‚", hp: -15 } },
                    { text: "å¿«æ­¥é›¢é–‹", type: "safe",
                      result: { msg: "ä½ å£“ä½å¸½æ²¿å¿«æ­¥é›¢é–‹ã€‚åœ¨é€™å€‹æ™‚ä»£ï¼Œå¥½å¥‡å¿ƒæœƒæ®ºæ­»äººã€‚", hp: 0 } }
                ]
            },
            {
                title: "è¡—é ­ç›¤æŸ¥",
                desc: "å…©å€‹æ†²å…µæ””ä½äº†ä½ çš„å»è·¯ï¼Œè¦æ±‚æŸ¥çœ‹èº«åˆ†è­‰ï¼Œä¸¦è³ªå•ä½ ç‚ºä½•æ™šæ­¸ã€‚",
                choices: [
                    { text: "è§£é‡‹ç†ç”±", type: "check", difficulty: 3, skill: "social",
                      success: { msg: "ä½ å†·éœåœ°æ‡‰å°ï¼Œç”šè‡³éä¸Šäº†ä¸€æ ¹è¸ã€‚ä»–å€‘æ®æ‰‹æ”¾è¡Œã€‚", hp: 5 },
                      fail: { msg: "ä½ çš„è²éŸ³åœ¨é¡«æŠ–ã€‚ä»–å€‘è¦ºå¾—å¯ç–‘ï¼Œç”¨æ§æ‰˜é‡æ“Šäº†ä½ çš„è…¹éƒ¨ã€‚", hp: -10 } },
                    { text: "è½‰èº«é€ƒè·‘", type: "check", difficulty: 5, skill: "run",
                      success: { msg: "ä½ è¡å…¥ç†Ÿæ‚‰çš„æš—å··ï¼Œå¿ƒè‡Ÿç‹‚è·³ï¼Œä½†æˆåŠŸç”©æ‰äº†ä»–å€‘ã€‚", hp: 0 },
                      fail: { msg: "ç °ï¼ä¸€è²æ§éŸ¿ï¼Œä½ çš„è…¿éƒ¨ä¸­å½ˆè¢«æ•ã€‚", hp: -30 } }
                ]
            },
            {
                title: "å¯ç–‘çš„ä¿¡ä»¶",
                desc: "ä½ åœ¨ä¿¡ç®±ç™¼ç¾ä¸€å°æ²’æœ‰ç½²åçš„ä¿¡ï¼Œå…§å®¹éš±æ™¦åœ°æ‰¹è©•æ™‚æ”¿ã€‚",
                choices: [
                    { text: "ç‡’æ¯€ä¿¡ä»¶", type: "safe",
                      result: { msg: "ä½ çœ‹è‘—ç´™å¼µåœ¨ç«ç›†ä¸­åŒ–ç‚ºç°ç‡¼ï¼Œæ‰æ•¢å¤§å£å‘¼å¸ã€‚", hp: 5 } },
                    { text: "èˆ‰å ±ä¿¡ä»¶", type: "betray", // å‡ºè³£è‰¯å¿ƒé¡
                      result: { msg: "ä½ å°‡ä¿¡äº¤çµ¦äº†è­¦ç¸½ã€‚é›–ç„¶ç²å¾—äº†çé‡‘ï¼Œä½†ä½ è¦ºå¾—éˆé­‚å°‘äº†ä¸€å¡Šã€‚", hp: 20, sinner: true } }
                ]
            }
        ];

        // æ­·å²äº‹ä»¶ (å›ºå®šå¹´ä»½è§¸ç™¼)
        const historyTimeline = {
            1949: { title: "æ¾æ¹–ä¸ƒä¸€ä¸‰äº‹ä»¶", desc: "æµäº¡å¸«ç”Ÿè¢«å¼·è¿«ç·¨å…¥è»éšŠï¼Œæ ¡é•·å¼µæ•ä¹‹ç‚ºç¶­è­·å­¸ç”Ÿæ¬Šç›Šé­æ§æ±ºã€‚æ ¡åœ’å·²éæ·¨åœŸã€‚", hp: -10 },
            1952: { title: "é¹¿çªŸåŸºåœ°æ¡ˆ", desc: "è»è­¦åŒ…åœé¹¿çªŸæ‘ï¼Œè¨±å¤šæ‘æ°‘èˆ‡ç¤¦å·¥è¢«æŒ‡ç‚ºåŒªè«œï¼Œé­åˆ°å¤§è¦æ¨¡æ¿«æ•ã€‚", hp: -15 },
            1960: { title: "é›·éœ‡æ¡ˆçˆ†ç™¼", desc: "ã€Šè‡ªç”±ä¸­åœ‹ã€‹é›œèªŒç¤¾é­åœåˆŠï¼Œé›·éœ‡è¢«æ•ã€‚è¨€è«–è‡ªç”±é€²å…¥æœ€å¯’å†·çš„å†¬å¤©ã€‚", hp: -10 },
            1979: { title: "ç¾éº—å³¶äº‹ä»¶", desc: "ä¸–ç•Œäººæ¬Šæ—¥éŠè¡Œé­ç•¶å±€é®å£“ï¼Œå…¨å³¶å±•é–‹å¤§æœæ•ã€‚é¢¨è²é¶´å”³ï¼Œè‰æœ¨çš†å…µã€‚", hp: -25 },
            1980: { title: "æ—å®…è¡€æ¡ˆ", desc: "ç¾éº—å³¶å¤§å¯©æœŸé–“ï¼Œæ—ç¾©é›„å®¶å±¬æ…˜é­æ®ºå®³ã€‚ææ€–ä¸å†åªé‡å°ç•¶äº‹äººï¼Œæ›´é‡å°å®¶äººã€‚", hp: -20 },
            1981: { title: "é™³æ–‡æˆå‘½æ¡ˆ", desc: "æ—…ç¾å­¸è€…è¿”å°å¾Œé™³å±å°å¤§æ ¡åœ’ã€‚çŸ¥è­˜ä»½å­äººäººè‡ªå±ã€‚", hp: -15 },
            1984: { title: "æ±Ÿå—æ¡ˆ", desc: "æƒ…å ±å±€å‹¾çµé»‘é“èµ´ç¾åˆºæ®ºä½œå®¶åŠ‰å®œè‰¯ã€‚æ­¤äº‹éœ‡é©šåœ‹éš›ï¼Œå¨æ¬Šé«”åˆ¶é–‹å§‹é¬†å‹•ã€‚", hp: 0 }, // ç„¡å‚·
            1986: { title: "åœ“å±±çµ„é»¨", desc: "æ°‘ä¸»é€²æ­¥é»¨å®£ä½ˆæˆç«‹ã€‚é›–ç„¶å°šæœªè§£åš´ï¼Œä½†é»æ˜çš„æ›™å…‰å·²ç¾ã€‚", hp: 30 } // å¤§è£œè¡€
        };

        // --- éŠæˆ²ç‹€æ…‹ ---
        let state = {
            year: 1949,
            role: 'student',
            hp: 100,
            maxHp: 100,
            isSinner: false, // æ˜¯å¦åšéè™§å¿ƒäº‹
            historyQueue: [] // å¾…è§¸ç™¼çš„æ­·å²äº‹ä»¶
        };

        // åˆå§‹åŒ–
        function startGame(roleKey) {
            state.role = roleKey;
            state.hp = roles[roleKey].hp;
            state.maxHp = roles[roleKey].hp;
            state.year = 1949;
            state.isSinner = false;
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('role-display').innerText = `è§’è‰²: ${roles[roleKey].name}`;
            updateStatus();
            
            // ç¬¬ä¸€å€‹äº‹ä»¶ï¼šé–‹å ´
            triggerEvent({
                title: "æˆ’åš´ä»¤é ’å¸ƒ",
                desc: "1949å¹´5æœˆ19æ—¥ï¼Œå°ç£çœè­¦å‚™ç¸½å¸ä»¤éƒ¨å®£å‘Šï¼šè‡ªæ˜æ—¥é›¶æ™‚èµ·ï¼Œå…¨å¢ƒå¯¦æ–½æˆ’åš´ã€‚é€™ä¸æ˜¯éŠæˆ²ï¼Œé€™æ˜¯æ­·å²çš„é‡æ¼”ã€‚",
                choices: [
                    { text: "æ²ˆé»˜åœ°æ´»ä¸‹å»", type: "safe", result: { msg: "ä½ ä½ä¸‹é ­ï¼Œæ··å…¥äººç¾¤ã€‚", hp: 0 } }
                ]
            }, true);
        }

        // æ›´æ–°ç‹€æ…‹æ¬„
        function updateStatus() {
            document.getElementById('year-text').innerText = state.year;
            if(state.year >= 1986) document.getElementById('year-text').classList.add('year-active');
            
            const hpPercent = Math.max(0, (state.hp / state.maxHp) * 100);
            document.getElementById('hp-bar').style.width = `${hpPercent}%`;
            document.getElementById('hp-text').innerText = `HP: ${state.hp} / ${state.maxHp}`;
            
            if(state.hp <= 0) gameOver();
        }

        // è§¸ç™¼äº‹ä»¶
        function triggerEvent(eventData, isHistory = false) {
            const container = document.getElementById('story-board');
            const controls = document.getElementById('control-panel');
            
            // å»ºç«‹äº‹ä»¶å¡ç‰‡
            const card = document.createElement('div');
            card.className = `event-card ${isHistory ? 'history' : ''}`;
            card.innerHTML = `
                <div class="event-title">${eventData.title}</div>
                <div class="event-desc">${eventData.desc}</div>
                <div class="result-box" id="result-${state.year}"></div>
            `;
            container.appendChild(card);
            
            // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
            setTimeout(() => container.scrollTop = container.scrollHeight, 100);

            // ç”ŸæˆæŒ‰éˆ•
            controls.innerHTML = ''; // æ¸…ç©ºèˆŠæŒ‰éˆ•
            
            // å¦‚æœæ˜¯ç´”æ­·å²äº‹ä»¶ï¼ˆæ²’æœ‰é¸é …ï¼Œåªæœ‰ç¢ºèªï¼‰
            if (isHistory && (!eventData.choices || eventData.choices.length === 0)) {
                const btn = document.createElement('div');
                btn.className = 'choice-btn btn-continue';
                btn.style.display = 'block';
                btn.innerText = 'ç¹¼çºŒ...';
                btn.onclick = () => {
                    applyResult(eventData.hp || 0, null);
                    nextTurn();
                };
                controls.appendChild(btn);
                return;
            }

            // ç”Ÿæˆé¸é …æŒ‰éˆ•
            eventData.choices.forEach(choice => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn';
                
                let tag = "";
                if (choice.type === 'check') tag = `æª¢å®š (é›£åº¦ ${choice.difficulty})`;
                if (choice.type === 'safe') tag = `å®‰å…¨`;
                if (choice.type === 'betray') tag = `ä»£åƒ¹`;

                btn.innerHTML = `<span>${choice.text}</span> <span class="choice-tag">${tag}</span>`;
                
                btn.onclick = () => handleChoice(choice, card);
                controls.appendChild(btn);
            });
        }

        // è™•ç†ç©å®¶é¸æ“‡
        function handleChoice(choice, cardElement) {
            const resultBox = cardElement.querySelector('.result-box');
            const controls = document.getElementById('control-panel');
            controls.innerHTML = ''; // æ¸…ç©ºæŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š

            let hpChange = 0;
            let message = "";
            let isSuccess = true;

            if (choice.type === 'safe' || choice.type === 'betray') {
                // ç›´æ¥çµç®—
                hpChange = choice.result.hp;
                message = choice.result.msg;
                if (choice.result.sinner) state.isSinner = true;
            } else if (choice.type === 'check') {
                // æ“²éª°å­æ©Ÿåˆ¶
                const dice = Math.floor(Math.random() * 6) + 1;
                let finalRoll = dice;
                
                // æŠ€èƒ½åŠ æˆ
                const myBonus = roles[state.role].bonus;
                if (myBonus === choice.skill) {
                    finalRoll += 2; // æœ‰æŠ€èƒ½ +2
                    message += `[${roles[state.role].name}å„ªå‹¢] `;
                }

                if (finalRoll >= choice.difficulty) {
                    // æˆåŠŸ
                    hpChange = choice.success.hp;
                    message += `(æ“²å‡º ${dice}${myBonus===choice.skill?'+2':''}) æˆåŠŸï¼<br>${choice.success.msg}`;
                    resultBox.className = "result-box result-success";
                } else {
                    // å¤±æ•—
                    hpChange = choice.fail.hp;
                    message += `(æ“²å‡º ${dice}${myBonus===choice.skill?'+2':''}) å¤±æ•—...<br>${choice.fail.msg}`;
                    resultBox.className = "result-box result-fail";
                    isSuccess = false;
                }
            }

            // é¡¯ç¤ºçµæœ
            resultBox.innerHTML = message;
            resultBox.style.display = 'block';
            applyResult(hpChange);

            // é¡¯ç¤ºã€Œä¸‹ä¸€å›åˆã€æŒ‰éˆ•
            const nextBtn = document.createElement('div');
            nextBtn.className = 'choice-btn btn-continue';
            nextBtn.style.display = 'block';
            nextBtn.innerText = 'ä¸‹ä¸€å¹´...';
            nextBtn.onclick = () => nextTurn();
            controls.appendChild(nextBtn);
        }

        function applyResult(amount) {
            if (!amount) return;
            state.hp += amount;
            if (state.hp > 100 && state.role !== 'worker') state.hp = 100;
            if (state.hp > 120 && state.role === 'worker') state.hp = 120;
            updateStatus();
        }

        // å›åˆæ¨é€²ç³»çµ±
        function nextTurn() {
            if (state.hp <= 0) return; // å·²æ­»äº¡

            // æ™‚é–“æ¨é€² (éš¨æ©Ÿ 2-4 å¹´)
            state.year += Math.floor(Math.random() * 3) + 2;
            
            // æª¢æŸ¥æ˜¯å¦è©²çµæŸ
            if (state.year >= 1987) {
                state.year = 1987;
                updateStatus();
                triggerEnding();
                return;
            }

            updateStatus();

            // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²äº‹ä»¶éœ€è¦è£œè§¸ç™¼
            // é‚è¼¯ï¼šæ‰¾å‡ºæ‰€æœ‰å¹´ä»½ <= ç•¶å‰å¹´ä»½ ä¸” å°šæœªè§¸ç™¼çš„æ­·å²äº‹ä»¶
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘é€™è£¡ç°¡å–®åˆ¤å®šï¼šå¦‚æœç•¶å‰å¹´ä»½è¶…è¶Šäº†æŸå€‹æ­·å²äº‹ä»¶é»ï¼Œå„ªå…ˆè§¸ç™¼æ­·å²äº‹ä»¶
            
            let historyHit = null;
            const years = Object.keys(historyTimeline).map(Number).sort((a,b)=>a-b);
            
            // æ‰¾å‡ºæœ€è¿‘ä¸€å€‹é‚„æ²’ç™¼ç”Ÿéï¼Œä¸”å¹´ä»½å·²ç¶“åˆ°çš„æ­·å²äº‹ä»¶
            // é€™è£¡æˆ‘å€‘ç°¡åŒ–é‚è¼¯ï¼šæ¯æ¬¡ nextTurn åªè§¸ç™¼ä¸€å€‹äº‹ä»¶ã€‚
            // å¦‚æœè©²å¹´ä»½æœ‰æ­·å²äº‹ä»¶ï¼Œè§¸ç™¼æ­·å²äº‹ä»¶ï¼›å¦å‰‡è§¸ç™¼éš¨æ©Ÿäº‹ä»¶ã€‚
            
            // ç‚ºäº†è®“æ­·å²äº‹ä»¶å¿…å‡ºï¼Œæˆ‘å€‘æª¢æŸ¥ç¯„åœ
            for (let y of years) {
                if (state.year >= y && !historyTimeline[y].triggered) {
                    historyHit = historyTimeline[y];
                    historyTimeline[y].triggered = true; // æ¨™è¨˜å·²è§¸ç™¼
                    break;
                }
            }

            if (historyHit) {
                triggerEvent(historyHit, true);
            } else {
                // éš¨æ©Ÿäº‹ä»¶
                const randIndex = Math.floor(Math.random() * randomEvents.length);
                triggerEvent(randomEvents[randIndex]);
            }
        }

        // çµå±€ç³»çµ±
        function triggerEnding() {
            const screen = document.getElementById('end-screen');
            const title = document.getElementById('end-title');
            const desc = document.getElementById('end-desc');
            
            screen.style.display = 'flex';
            title.innerText = "1987 æˆ’åš´è§£é™¤";

            let content = "";
            if (state.isSinner) {
                content = `
                    <p style="color:#ff6b6b; font-weight:bold;">ä½ æ´»ä¸‹ä¾†äº†ï¼Œä½†éˆé­‚å·²æ­»ã€‚</p>
                    <p>ç•¶æ•´åº§å³¶å¶¼åœ¨æ…¶ç¥è‡ªç”±æ™‚ï¼Œä½ æƒ³èµ·äº†ç•¶å¹´ç‚ºäº†ä¿å‘½è€Œå¯«ä¸‹çš„é‚£äº›åå­—ã€‚</p>
                    <p>é‚£äº›è¢«ä½ å‡ºè³£çš„æ‘¯å‹ï¼Œå†ä¹Ÿæ²’æœ‰å›ä¾†ã€‚é€™ä»½æ„§ç–šï¼Œæ˜¯ä½ é¤˜ç”Ÿå”¯ä¸€çš„è¡Œæã€‚</p>
                `;
            } else {
                content = `
                    <p style="color:var(--highlight); font-weight:bold;">ä½ å•å¿ƒç„¡æ„§åœ°æ´»ä¸‹ä¾†äº†ã€‚</p>
                    <p>ä½ æ’éäº†æ¼«é•·çš„é»‘å¤œï¼Œçµ‚æ–¼ç­‰åˆ°äº†é»æ˜ã€‚</p>
                `;
            }

            content += `
                <hr style="border-color:#333; margin:20px 0;">
                <p style="color:#888; font-size:14px;">
                    ç„¶è€Œï¼Œé€™ä¸¦éè‡ªç”±çš„çµ‚é»ã€‚<br><br>
                    <span style="color:#ccc">åˆ‘æ³•100æ¢</span> ä»ç®åˆ¶è‘—æ€æƒ³ï¼Œ<br>
                    <span style="color:#ccc">è¬å¹´åœ‹æœƒ</span> ä¾èˆŠæŠŠæŒè‘—æ¬ŠåŠ›ã€‚<br><br>
                    å¿ƒä¸­çš„è­¦ç¸½å°šæœªé›¢å»ã€‚<br>
                    é»æ˜é›–ç„¶åˆ°ä¾†ï¼Œä½†æˆ°é¬¥æ‰æ­£è¦é–‹å§‹ã€‚
                </p>
            `;
            desc.innerHTML = content;
        }

        function gameOver() {
            const screen = document.getElementById('end-screen');
            const title = document.getElementById('end-title');
            const desc = document.getElementById('end-desc');
            
            screen.style.display = 'flex';
            title.innerText = "ğŸ¥€ æ®è½";
            title.style.color = "var(--danger)";
            
            desc.innerHTML = `
                <p>æ§è²åŠƒç ´äº†å¯‚éœçš„æ¸…æ™¨ï¼Œæˆ–è€…ï¼Œæ˜¯åœ¨æŸå€‹ç„¡äººçŸ¥æ›‰çš„æ·±å¤œè£¡åœæ­¢äº†å‘¼å¸ã€‚</p>
                <p>ä½ çš„å®¶äººé‚„åœ¨ç­‰è‘—ä½ å›å®¶åƒæ™šé£¯ï¼Œä½†é‚£å¼µæ¤…å­å°‡æ°¸é ç©ºè‘—ã€‚</p>
                <p style="color:#888; margin-top:20px;">ä½ æˆç‚ºäº†æ™‚ä»£æ´ªæµä¸‹ï¼Œä¸€å€‹æ²’æœ‰åå­—çš„æ•¸å­—ã€‚</p>
            `;
        }

    </script>
</body>
</html>
